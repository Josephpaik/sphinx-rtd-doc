<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" />

    <meta name="generator" content="sphinx-4.2.0, furo 2022.06.21"/>
        <title>Multi-Node - Tech.Writer &#34;0.2.4&#34; documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?digest=40978830699223671f4072448e654b5958f38b89" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">Tech.Writer "0.2.4" documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">Tech.Writer "0.2.4" documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">사용자 가이드:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="notebooks/mytutorial.html">튜토리얼</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">달팽이 라이브러리 사용자 가이드</a></li>
<li class="toctree-l1"><a class="reference internal" href="sample2.html">QUICK GUIDE</a></li>
<li class="toctree-l1"><a class="reference internal" href="value_proposition_design.html">밸류 프로포지션 디자인</a></li>
<li class="toctree-l1"><a class="reference internal" href="VDI%20tutorial-noPicture_220809.html">VDI 튜토리얼</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <a class="reference internal image-reference" href="_images/image1.png"><img alt="_images/image1.png" src="_images/image1.png" style="width: 2.51217in; height: 0.89583in;" /></a>
<p><strong>Version : 0.1</strong></p>
<p><strong>Release : 2022/06/01</strong></p>
<p><strong>Writer : 김성진 선임연구원</strong></p>
<p><strong>Confirm : 이상석 수석연구원</strong></p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p class="toc-heading rubric" id="id1"><strong>내용</strong></p>
<p><a class="reference external" href="#openstack-stein-packstack">1. Openstack - Stein ( Packstack )</a>
<a class="reference external" href="#openstack-stein-packstack">5</a></p>
<p><a class="reference external" href="#구축-사내-공용-네트워크">1.1. 구축 - 사내 공용 네트워크</a>
<a class="reference external" href="#구축-사내-공용-네트워크">5</a></p>
<p><a class="reference external" href="#기본-요구사항">1.1.1. 기본 요구사항</a> <a class="reference external" href="#기본-요구사항">5</a></p>
<p><a class="reference external" href="#운영체제">1.1.1.1. 운영체제</a> <a class="reference external" href="#운영체제">5</a></p>
<p><a class="reference external" href="#물리-서버-기본-구성">1.1.2. 물리 서버 기본 구성</a>
<a class="reference external" href="#물리-서버-기본-구성">5</a></p>
<p><a class="reference external" href="#all-in-one">1.1.2.1. All-in-One</a> <a class="reference external" href="#all-in-one">5</a></p>
<p><a class="reference external" href="#multi-node">1.1.2.2. Multi-Node</a> <a class="reference external" href="#multi-node">5</a></p>
<p><a class="reference external" href="#가용-repository-설정">1.1.3. 가용 Repository 설정</a>
<a class="reference external" href="#가용-repository-설정">6</a></p>
<p><a class="reference external" href="#infra-openstack-10.104.61.5-centos7-vm">1.1.3.1. Infra openstack : 10.104.61.5 ( Centos7 VM
)</a>
<a class="reference external" href="#infra-openstack-10.104.61.5-centos7-vm">6</a></p>
<p><a class="reference external" href="#os-환경-요구사항">1.1.4. OS 환경 요구사항</a>
<a class="reference external" href="#os-환경-요구사항">6</a></p>
<p><a class="reference external" href="#packstack-으로-openstack-설치">1.1.5. Packstack 으로 Openstack
설치</a>
<a class="reference external" href="#packstack-으로-openstack-설치">6</a></p>
<p><a class="reference external" href="#패키지-설치">1.1.5.1. 패키지 설치</a> <a class="reference external" href="#패키지-설치">6</a></p>
<p><a class="reference external" href="#answer.txt-파일-생성">1.1.5.2. answer.txt 파일 생성</a>
<a class="reference external" href="#answer.txt-파일-생성">7</a></p>
<p><a class="reference external" href="#answer.txt-파일-수정">1.1.5.3. answer.txt 파일 수정</a>
<a class="reference external" href="#answer.txt-파일-수정">7</a></p>
<p><a class="reference external" href="#packstack-실행">1.1.5.4. packstack 실행</a> <a class="reference external" href="#packstack-실행">7</a></p>
<p><a class="reference external" href="#설치-후-옵션-수정">1.1.5.5. 설치 후 옵션 수정</a>
<a class="reference external" href="#설치-후-옵션-수정">8</a></p>
<p><a class="reference external" href="#ceph-cluster-구성">1.1.6. Ceph Cluster 구성</a>
<a class="reference external" href="#ceph-cluster-구성">8</a></p>
<p><a class="reference external" href="#high-availability-구성">1.2. High Availability 구성</a>
<a class="reference external" href="#high-availability-구성">8</a></p>
<p><a class="reference external" href="#ha-구성도">1.2.1. HA 구성도</a> <a class="reference external" href="#ha-구성도">8</a></p>
<p><a class="reference external" href="#ha---controller-구성">1.2.2. HA - Controller 구성</a>
<a class="reference external" href="#ha---controller-구성">8</a></p>
<p><a class="reference external" href="#packstack">1.2.2.1. Packstack</a> <a class="reference external" href="#packstack">9</a></p>
<p><a class="reference external" href="#memcached">1.2.2.2. Memcached</a> <a class="reference external" href="#memcached">9</a></p>
<p><a class="reference external" href="#rabbitmq-1">1.2.2.3. Rabbitmq</a> <a class="reference external" href="#rabbitmq-1">9</a></p>
<p><a class="reference external" href="#pcscorosyncpacemaker-설치-구성">1.2.2.4. pcs/corosync/pacemaker 설치
구성</a>
<a class="reference external" href="#pcscorosyncpacemaker-설치-구성">10</a></p>
<p><a class="reference external" href="#mariadb-galera-cluster">1.2.2.5. Mariadb Galera Cluster</a>
<a class="reference external" href="#mariadb-galera-cluster">12</a></p>
<p><a class="reference external" href="#openstack-api-haproxy">1.2.2.6. Openstack API HAProxy</a>
<a class="reference external" href="#openstack-api-haproxy">14</a></p>
<p><a class="reference external" href="#ha---network-구성">1.2.3. HA - Network 구성</a>
<a class="reference external" href="#ha---network-구성">18</a></p>
<p><a class="reference external" href="#configuring-layer-3-high-availability-ha">1.2.3.1. Configuring Layer 3 high availability
(HA)</a>
<a class="reference external" href="#configuring-layer-3-high-availability-ha">18</a></p>
<p><a class="reference external" href="#l3-ha-구성-검증">1.2.3.2. L3 HA 구성 검증</a>
<a class="reference external" href="#l3-ha-구성-검증">19</a></p>
<p><a class="reference external" href="#high-availability-for-dhcp">1.2.3.3. High-availability for DHCP</a>
<a class="reference external" href="#high-availability-for-dhcp">19</a></p>
<p><a class="reference external" href="#high-availability-for-lbaasv2">1.2.3.4. High-availability for
LBaasV2</a>
<a class="reference external" href="#high-availability-for-lbaasv2">19</a></p>
<p><a class="reference external" href="#nova-compute-evacute">1.2.3.5. Nova-Compute Evacute</a>
<a class="reference external" href="#nova-compute-evacute">20</a></p>
<p><a class="reference external" href="#openstackstein-tuning-for-vd-i">1.3. Openstack(Stein) Tuning for
VD-i</a>
<a class="reference external" href="#openstackstein-tuning-for-vd-i">20</a></p>
<p><a class="reference external" href="#성능-최적화-참고자료">1.3.1. 성능 최적화 참고자료</a>
<a class="reference external" href="#성능-최적화-참고자료">20</a></p>
<p><a class="reference external" href="#openstack-실적용-튜닝-옵션">1.3.2. Openstack 실적용 튜닝 옵션</a>
<a class="reference external" href="#openstack-실적용-튜닝-옵션">21</a></p>
<p><a class="reference external" href="#기타-튜닝-bios-os-raid-등">1.3.3. 기타 튜닝 – BIOS, OS, RAID 등</a>
<a class="reference external" href="#기타-튜닝-bios-os-raid-등">22</a></p>
<p><a class="reference external" href="#troubole-shootingstein">1.4. Troubole Shooting</a>
<a class="reference external" href="#troubole-shootingstein">22</a></p>
<p><a class="reference external" href="#openstack-wallaby-kolla-ansible">2. Openstack – Wallaby ( Kolla-Ansible
)</a>
<a class="reference external" href="#openstack-wallaby-kolla-ansible">22</a></p>
<p><a class="reference external" href="#기본요구사항">2.1. 기본요구사항</a> <a class="reference external" href="#기본요구사항">22</a></p>
<p><a class="reference external" href="#운영체제-1">2.1.1. 운영체제</a> <a class="reference external" href="#운영체제-1">22</a></p>
<p><a class="reference external" href="#openstack">2.1.2. Openstack</a> <a class="reference external" href="#openstack">23</a></p>
<p><a class="reference external" href="#kolla-ansible">2.1.3. Kolla-ansible</a> <a class="reference external" href="#kolla-ansible">23</a></p>
<p><a class="reference external" href="#사전준비">2.2. 사전준비</a> <a class="reference external" href="#사전준비">23</a></p>
<p><a class="reference external" href="#bond-인터페이스-구성">2.2.1. Bond 인터페이스 구성</a>
<a class="reference external" href="#bond-인터페이스-구성">23</a></p>
<p><a class="reference external" href="#os-환경-설정">2.2.2. OS 환경 설정</a> <a class="reference external" href="#os-환경-설정">23</a></p>
<p><a class="reference external" href="#배포-서버의-공개키-배포">2.2.3. 배포 서버의 공개키 배포</a>
<a class="reference external" href="#배포-서버의-공개키-배포">24</a></p>
<p><a class="reference external" href="#물리서버-구성">2.3. 물리서버 구성</a> <a class="reference external" href="#물리서버-구성">24</a></p>
<p><a class="reference external" href="#deploy-서버-구성">2.4. Deploy 서버 구성</a>
<a class="reference external" href="#deploy-서버-구성">24</a></p>
<p><a class="reference external" href="#kolla-ansible-설치">2.4.1. Kolla-Ansible 설치</a>
<a class="reference external" href="#kolla-ansible-설치">25</a></p>
<p><a class="reference external" href="#inventory-파일-수정">2.4.2. Inventory 파일 수정</a>
<a class="reference external" href="#inventory-파일-수정">25</a></p>
<p><a class="reference external" href="#passwords.yml-생성">2.4.3. passwords.yml 생성</a>
<a class="reference external" href="#passwords.yml-생성">26</a></p>
<p><a class="reference external" href="#octavia-인증서-생성">2.4.4. Octavia 인증서 생성</a>
<a class="reference external" href="#octavia-인증서-생성">26</a></p>
<p><a class="reference external" href="#globals.yml-구성">2.4.5. globals.yml 구성</a>
<a class="reference external" href="#globals.yml-구성">27</a></p>
<p><a class="reference external" href="#overcloud-필수-패키지-배포">2.4.6. OverCloud 필수 패키지 배포</a>
<a class="reference external" href="#overcloud-필수-패키지-배포">28</a></p>
<p><a class="reference external" href="#ceph-cluster-구성-1">2.4.7. Ceph Cluster 구성</a>
<a class="reference external" href="#ceph-cluster-구성-1">28</a></p>
<p><a class="reference external" href="#cephadm-패키지-설치-및-ceph-cluster-배포">2.4.7.1. Cephadm 패키지 설치 및 Ceph Cluster
배포</a>
<a class="reference external" href="#cephadm-패키지-설치-및-ceph-cluster-배포">28</a></p>
<p><a class="reference external" href="#ceph-osd-생성">2.4.7.2. Ceph OSD 생성</a> <a class="reference external" href="#ceph-osd-생성">29</a></p>
<p><a class="reference external" href="#ceph-pool-생성">2.4.7.3. Ceph Pool 생성</a>
<a class="reference external" href="#ceph-pool-생성">30</a></p>
<p><a class="reference external" href="#ceph-pool-keyring-생성-및-deploy-노드로-복사">2.4.7.4. Ceph Pool Keyring 생성 및 Deploy 노드로
복사</a>
<a class="reference external" href="#ceph-pool-keyring-생성-및-deploy-노드로-복사">30</a></p>
<p><a class="reference external" href="#glance.conf-생성">2.4.7.5. glance.conf 생성</a>
<a class="reference external" href="#glance.conf-생성">31</a></p>
<p><a class="reference external" href="#kolla-ansible-openstack-container-배포">2.5. Kolla-Ansible Openstack container
배포</a>
<a class="reference external" href="#kolla-ansible-openstack-container-배포">31</a></p>
<p><a class="reference external" href="#openstack-cli-설치">2.6. Openstack CLI 설치</a>
<a class="reference external" href="#openstack-cli-설치">31</a></p>
<p><a class="reference external" href="#octavia-로드밸런서-구성">2.7. Octavia 로드밸런서 구성</a>
<a class="reference external" href="#octavia-로드밸런서-구성">32</a></p>
<p><a class="reference external" href="#amphora-이미지">2.7.1. Amphora 이미지</a> <a class="reference external" href="#amphora-이미지">32</a></p>
<p><a class="reference external" href="#amphora-인스턴스-라우팅-설정">2.7.2. Amphora 인스턴스 라우팅
설정</a>
<a class="reference external" href="#amphora-인스턴스-라우팅-설정">32</a></p>
<p><a class="reference external" href="#로드밸런서-생성">2.7.3. 로드밸런서 생성</a>
<a class="reference external" href="#로드밸런서-생성">33</a></p>
<p><a class="reference external" href="#리스너-생성">2.7.4. 리스너 생성</a> <a class="reference external" href="#리스너-생성">33</a></p>
<p><a class="reference external" href="#멤버-추가">2.7.5. 멤버 추가</a> <a class="reference external" href="#멤버-추가">33</a></p>
<p><a class="reference external" href="#상태모니터-생성">2.7.6. 상태모니터 생성</a>
<a class="reference external" href="#상태모니터-생성">33</a></p>
<p><a class="reference external" href="#openstack-configuration">3. Openstack Configuration</a>
<a class="reference external" href="#openstack-configuration">34</a></p>
<p><a class="reference external" href="#project-생성">3.1. Project 생성</a> <a class="reference external" href="#project-생성">34</a></p>
<p><a class="reference external" href="#network-설정">3.2. Network 설정</a> <a class="reference external" href="#network-설정">36</a></p>
<p><a class="reference external" href="#public-네트워크-설정">3.2.1. Public 네트워크 설정</a>
<a class="reference external" href="#public-네트워크-설정">36</a></p>
<p><a class="reference external" href="#private-네트워크-설정">3.2.2. Private 네트워크 설정</a>
<a class="reference external" href="#private-네트워크-설정">38</a></p>
<p><a class="reference external" href="#snat-활성화">3.2.2.1. SNAT 활성화</a> <a class="reference external" href="#snat-활성화">38</a></p>
<p><a class="reference external" href="#snat-비활성화">3.2.2.2. SNAT 비활성화</a> <a class="reference external" href="#snat-비활성화">39</a></p>
<p><a class="reference external" href="#compute-flavor-구성">3.3. Compute Flavor 구성</a>
<a class="reference external" href="#compute-flavor-구성">43</a></p>
<p><a class="reference external" href="#glance-image-업로드">3.4. Glance Image 업로드</a>
<a class="reference external" href="#glance-image-업로드">44</a></p>
<p><a class="reference external" href="#multi-node-호스트집합">3.5. (Multi-Node) 호스트집합</a>
<a class="reference external" href="#multi-node-호스트집합">45</a></p>
<p><a class="reference external" href="#인스턴스-생성">3.6 인스턴스 생성</a> <a class="reference external" href="#인스턴스-생성">46</a></p>
<p><a class="reference external" href="#vd-i">4. VD-i</a> <a class="reference external" href="#vd-i">46</a></p>
<p><a class="reference external" href="#vd-i-인프라-구성도">4.1. VD-i 인프라 구성도</a>
<a class="reference external" href="#vd-i-인프라-구성도">46</a></p>
<p><a class="reference external" href="#vd-i-데이터-흐름도">4.2. VD-i 데이터 흐름도</a>
<a class="reference external" href="#vd-i-데이터-흐름도">47</a></p>
<p><a class="reference external" href="#사전-작업">4.3. 사전 작업</a> <a class="reference external" href="#사전-작업">47</a></p>
<p><a class="reference external" href="#vd-i-인프라-구축">4.4. VD-i 인프라 구축</a>
<a class="reference external" href="#vd-i-인프라-구축">47</a></p>
<p><a class="reference external" href="#vd-i-브로커">4.4.1. VD-i 브로커</a> <a class="reference external" href="#vd-i-브로커">47</a></p>
<p><a class="reference external" href="#운영체재">4.4.1.1. 운영체재</a> <a class="reference external" href="#운영체재">47</a></p>
<p><a class="reference external" href="#필수-패키지-설치">4.4.1.2. 필수 패키지 설치</a>
<a class="reference external" href="#필수-패키지-설치">47</a></p>
<p><a class="reference external" href="#debian-패키지로-설치하기">4.4.1.3. Debian 패키지로 설치하기</a>
<a class="reference external" href="#debian-패키지로-설치하기">47</a></p>
<p><a class="reference external" href="#nginx-설정">4.4.1.4. Nginx 설정</a> <a class="reference external" href="#nginx-설정">48</a></p>
<p><a class="reference external" href="#haproxy-설정">4.4.1.5. HAProxy 설정</a> <a class="reference external" href="#haproxy-설정">51</a></p>
<p><a class="reference external" href="#mbroker-설치">4.4.1.6. Mbroker 설치</a> <a class="reference external" href="#mbroker-설치">52</a></p>
<p><a class="reference external" href="#vsmgmt-설치">4.4.1.7. VSMGMT 설치</a> <a class="reference external" href="#vsmgmt-설치">53</a></p>
<p><a class="reference external" href="#vd-i-mariadb">4.4.2. VD-i MariaDB</a> <a class="reference external" href="#vd-i-mariadb">53</a></p>
<p><a class="reference external" href="#운영체재-1">4.4.2.1. 운영체재</a> <a class="reference external" href="#운영체재-1">53</a></p>
<p><a class="reference external" href="#vd-i-vsmetric">4.4.3. VD-i VSMetric</a> <a class="reference external" href="#vd-i-vsmetric">53</a></p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<p><strong>History</strong></p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 12%" />
<col style="width: 9%" />
<col style="width: 58%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Date</p></th>
<th class="head"><p>Revi
sion</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Author</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2022
-05-23</p></td>
<td><p>0.1</p></td>
<td><p>초안 작성 시작</p></td>
<td><p>김성진
선임연구원</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<ol class="arabic">
<li><p class="rubric" id="openstack-stein-packstack"><strong>Openstack - Stein ( Packstack )</strong></p>
<ol class="arabic">
<li><p class="rubric" id="id2"><strong>구축 - 사내 공용 네트워크</strong></p>
<ol class="arabic">
<li><p class="rubric" id="id3"><strong>기본 요구사항</strong></p>
<ol class="arabic">
<li><p class="rubric" id="id4">운영체제</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<ul>
<li><p>Version : CentOS 7.9.2009</p></li>
<li><p>Kernel : 3.10.0-1160.25.1.el7.x86_64</p>
<ol class="arabic">
<li><p class="rubric" id="id5"><strong>물리 서버 기본 구성</strong></p>
<ol class="arabic">
<li><p class="rubric" id="all-in-one">All-in-One</p>
</li>
</ol>
</li>
</ol>
</li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image2.png"><img alt="_images/image2.png" src="_images/image2.png" style="width: 4.35833in; height: 2.65in;" /></a>
</div></blockquote>
<section id="multi-node">
<h1>Multi-Node<a class="headerlink" href="#multi-node" title="Permalink to this headline">#</a></h1>
<a class="reference internal image-reference" href="_images/image3.png"><img alt="_images/image3.png" src="_images/image3.png" style="width: 6.69072in; height: 2.69167in;" /></a>
<ol class="arabic" start="2">
<li><p class="rubric" id="repository"><strong>가용 Repository 설정</strong></p>
<ol class="arabic">
<li><p class="rubric" id="infra-openstack-10-104-61-5-centos7-vm">Infra openstack : 10.104.61.5 ( Centos7 VM )</p>
</li>
</ol>
</li>
</ol>
<ul>
<li><div class="line-block">
<div class="line">sftp 로 접속하여 아래의 파일을 /root/ 로 가져온다.</div>
<div class="line">set_vdi_repo.sh</div>
<div class="line">wget-1.14-18.el7_6.1.x86_64.rpm</div>
</div>
</li>
<li><p>wget 설치 이후 set_vdi_repo.sh 를 실행하면 10.104.61.5 로
리포지토리가 10.104.61.5로 설정된다.</p>
<ol class="arabic">
<li><p class="rubric" id="os"><strong>OS 환경 요구사항</strong></p>
</li>
</ol>
</li>
<li><p>Packstack 설치 배포를 위해서 방화벽 설정 및 파일 오픈 개수 등의
설정을 진행한다.</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p># Packstack 은 최신 leatherman 패키지로 동작을 안하기 때문에
다운그레이드 진행</p>
<p># 목표 패키지 버전 : leatherman-1.3.0-9.el7.x86_64</p>
<p><strong>~# yum downgrade -y leatherman</strong></p>
<p># 설치작업에 방해되므로 firewalld 와 selinux 비활성화</p>
<p># Openstack 환경은 NetworkManager 를 사용하지 않으므로 비활성화</p>
<p><strong>~# systemctl disable firewalld NetworkManager</strong></p>
<p><strong>~# systemctl stop firewalld NetworkManager</strong></p>
<p># 임시적용위해서는 setenforce 영구 적용위해서는 /etc/selinux/config
파일 수정</p>
<p><strong>~# setenforce 0</strong></p>
<p><strong>~# sed -i ‘s/ SELINUX=enforcing/SELINUX=disabled/’
/etc/selinux/config</strong></p>
<p># OS의 파일 오픈 개수 조정</p>
<p><strong>~# vim /etc/security/limits.conf</strong></p>
<p>root soft nofile 65535</p>
<p>root hard nofile 65535</p>
<p>* soft nproc unlimited</p>
<p>* hard nproc unlimited</p>
<p>* soft nofile 500000</p>
<p>* hard nofile 500000</p>
<p># 설정 적용을 위해 재부팅</p>
<p><strong>~# shutdown -r now</strong></p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<ol class="arabic">
<li><p class="rubric" id="packstack-openstack"><strong>Packstack 으로 Openstack 설치</strong></p>
<ol class="arabic">
<li><p class="rubric" id="id6">패키지 설치</p>
</li>
</ol>
</li>
</ol>
<blockquote>
<div><p><strong>~# yum install -y openstack-packstack</strong></p>
</div></blockquote>
</section>
<section id="answer-txt">
<h1>answer.txt 파일 생성<a class="headerlink" href="#answer-txt" title="Permalink to this headline">#</a></h1>
<blockquote>
<div><p><strong>~# packstack -gen-answer-file=./answer.txt</strong></p>
</div></blockquote>
</section>
<section id="id7">
<h1>answer.txt 파일 수정<a class="headerlink" href="#id7" title="Permalink to this headline">#</a></h1>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p># 다음의 항목들을 수정한다.</p>
<p># (공통) All-in-One / Multi-node</p>
<p>CONFIG_KEYSTONE_ADMIN_USERNAME=admin</p>
<p>CONFIG_KEYSTONE_ADMIN_PW=<strong>오픈스택 대시보드 패스워드</strong></p>
<p>CONFIG_DEFAULT_PASSWORD=sms980502!</p>
<p>CONFIG_CONTROLLER_HOST=10.104.102.110</p>
<p>CONFIG_COMPUTE_HOSTS=10.104.102.110</p>
<p>CONFIG_NETWORK_HOSTS=10.104.102.110</p>
<p>CONFIG_MARIADB_PW=sms980502!</p>
<p>CONFIG_NOVA_SCHED_CPU_ALLOC_RATIO=3.0</p>
<p>CONFIG_NOVA_SCHED_RAM_ALLOC_RATIO=1.0</p>
<p>CONFIG_LBAAS_INSTALL=y</p>
<p>CONFIG_NEUTRON_ML2_TYPE_DRIVERS=flat,vxlan</p>
<p>CONFIG_NEUTRON_ML2_TENANT_NETWORK_TYPES=vxlan</p>
<p>CONFIG_NEUTRON_ML2_MECHANISM_DRIVERS=openvswitch</p>
<p>CONFIG_NEUTRON_OVS_BRIDGE_MAPPINGS=extnet:br-ex</p>
<p>CONFIG_NEUTRON_OVS_BRIDGE_IFACES=br-ex:em1</p>
<p>CONFIG_NEUTRON_OVS_EXTERNAL_PHYSNET=extnet</p>
<p>CONFIG_NEUTRON_OVN_BRIDGE_MAPPINGS=extnet:br-ex</p>
<p>CONFIG_PROVISION_DEMO=n</p>
<p># Multinode</p>
<p>CONFIG_COMPUTE_HOSTS=10.104.102.16,10.104.102.17</p>
<p>CONFIG_NETWORK_HOSTS=10.104.102.13,10.104.102.14,10.104.102.15</p>
<p>CONFIG_NEUTRON_OVS_BRIDGE_MAPPINGS=extnet:br-ex,physnet10:br-port</p>
<p>CONFIG_NEUTRON_OVS_BRIDGE_IFACES=br-ex:bond1,br-port:bond10</p>
<p>CONFIG_NEUTRON_OVS_BRIDGES_COMPUTE=br-port</p>
<p>CONFIG_NEUTRON_OVS_EXTERNAL_PHYSNET=extnet</p>
<p>CONFIG_NEUTRON_OVS_TUNNEL_IF=bond10</p>
<p>CONFIG_NEUTRON_OVS_TUNNEL_SUBNETS=192.168.10.0/24</p>
<p>CONFIG_NEUTRON_OVS_VXLAN_UDP_PORT=4789</p>
<p>CONFIG_NEUTRON_OVN_BRIDGE_MAPPINGS=extnet:br-ex</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="packstack">
<h1>packstack 실행<a class="headerlink" href="#packstack" title="Permalink to this headline">#</a></h1>
<blockquote>
<div><p><strong>~# packstack –answer-file=./answer.txt</strong></p>
</div></blockquote>
<a class="reference internal image-reference" href="_images/image4.png"><img alt="_images/image4.png" src="_images/image4.png" style="width: 6.51667in; height: 1.175in;" /></a>
</section>
<section id="id8">
<h1>설치 후 옵션 수정<a class="headerlink" href="#id8" title="Permalink to this headline">#</a></h1>
<blockquote>
<div><p>설치 완료된 이후 서비스들의 기본값으로는 사용이 불가하므로 아래와
같이 조정한다.</p>
</div></blockquote>
<section id="rabbitmq">
<h2>Rabbitmq<a class="headerlink" href="#rabbitmq" title="Permalink to this headline">#</a></h2>
<p>~# vim /usr/lib/systemd/system/rabbitmq-server.service</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>[Service]</p>
<p>LimitNOFILE=16384</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="mariadb">
<h2>Mariadb<a class="headerlink" href="#mariadb" title="Permalink to this headline">#</a></h2>
<p>~# vim /usr/lib/systemd/system/mariadb.service</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>[Service]</p>
<p>LimitNOFILE=infinity</p>
<p>LimitMEMLOCK=infinity</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<section id="ceph-cluster">
<h1><strong>Ceph Cluster 구성</strong><a class="headerlink" href="#ceph-cluster" title="Permalink to this headline">#</a></h1>
<ol class="arabic">
<li><p class="rubric" id="high-availability"><strong>High Availability 구성</strong></p>
<ol class="arabic">
<li><p class="rubric" id="ha"><strong>HA 구성도</strong></p>
</li>
</ol>
</li>
</ol>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image5.png"><img alt="_images/image5.png" src="_images/image5.png" style="width: 6.53333in; height: 2.19167in;" /></a>
</div></blockquote>
</section>
<section id="ha-controller">
<h1><strong>HA - Controller 구성</strong><a class="headerlink" href="#ha-controller" title="Permalink to this headline">#</a></h1>
<ul>
<li><p>컨트롤러 HA는 두대의 컨트롤러 노드가 동일한 Conf 파일을 가지고 동일한
MariaDB 를 바라보며 오픈스택 서비스를 구동하고 pcsd 로 클러스터링하여
생성한 VIP를 가지고 Active-Stanby 형식으로 동작한다.</p></li>
<li><p>성능과 안정성에 주의를 요하는 MariaDB, Rabbitmq, Keystone, Nova,
Cinder, Neutron 의 주요서비스의 Endpoint 및 API 는 네트워크 노드에
별도 구성한 VIP와 HAPROXY 를 통하여 HA 환경을 구성한다.</p></li>
<li><p><strong>(반성) pcs/corosync/pacemaker 는 서비스 데몬 상태를 모니터링하고
제어 등을 수행할 수 있었는데 현재는 VIP 생성용도로만 쓰고 있어서
차라리 keepalived 만 올리는게 더 가벼울 거 같다.</strong></p>
<ol class="arabic">
<li><p class="rubric" id="id9">Packstack</p>
</li>
</ol>
</li>
<li><div class="line-block">
<div class="line">먼저 설치한 Controller 노드(이하 Control1)에서 answer.txt 파일을
복사하고 기존 설치된</div>
<div class="line">호스트 들을 EXCLUDE_SERVERS에 등록하고 Control1의 IP를 Control2
IP로 수정한다.</div>
</div>
</li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>EXCLUDE_SERVERS={먼저설치한모든HOST_IP}</p>
<p>CONFIG_CONTROLLER_HOST={추가한컨트롤러IP}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><div class="line-block">
<div class="line">수정한 answer.txt 파일로 packstack 을 실행하여 Control2 를
설치한다.</div>
<div class="line"><strong>~# packstack -answer-file=./answer.txt</strong></div>
</div>
<ol class="arabic">
<li><p class="rubric" id="memcached">Memcached</p>
</li>
</ol>
</li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 9%" />
<col style="width: 24%" />
<col style="width: 45%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Ser
vice</p></th>
<th class="head"><p>File</p></th>
<th class="head"><p>Parameters</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Keys
tone</p></td>
<td><p>/etc/keystone
/keystone.conf</p></td>
<td><p>[cache]</p>
<p>backend =
oslo_cache.memcache_pool</p>
<p>enabled = True</p>
<p>memcache_servers =
10.10
.20.11:11211,101020.11:11211</p>
</td>
<td><p>다중화된
컨트롤러에서
캐시를
공유하여
인증정보를
공유한다.
이렇게하면
401에러를
대부분 없앨
수 있다.</p></td>
</tr>
<tr class="row-odd"><td><p>Nova</p>
<p>Neu
tron</p>
</td>
<td><p>/etc/
nova/nova.conf</p>
<p>/et
c/neutron/meta
data_agent.ini</p>
</td>
<td><p>memcache_servers=10.104.71
.11:11211,10.104.71.12:11211</p></td>
<td><ul class="simple">
<li></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>Neu
tron</p>
<p>Ci
nder</p>
<p>Gl
ance</p>
</td>
<td><p>/etc/neutro
n/neutron.conf</p>
<p>/etc/cind
er/cinder.conf</p>
<p>/etc/glance/g
lance-api.conf</p>
<p>/etc
/glance/glance
-registry.conf</p>
</td>
<td><p>memcached_servers=10.104.71
.11:11211,10.104.71.12:11211</p></td>
<td><ul class="simple">
<li></li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
<ol class="arabic" start="2">
<li><p class="rubric" id="rabbitmq-1">Rabbitmq</p>
<ol class="arabic">
<li><p class="rubric" id="rabbitmq-server-ha">Rabbitmq-server HA 구성</p>
</li>
</ol>
</li>
</ol>
<ul class="simple">
<li><p>Rabbitmq 서비스를 중지하고 첫번째 노드에서 쿠키를 다른 노드에
복사한다.</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>~# scp /var/lib/rabbitmq/.erlang.cookie
<a class="reference external" href="mailto:root&#37;&#52;&#48;control2">root<span>&#64;</span>control2</a>:/var/lib/rabbitmq/.erlang.cookie</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<ul class="simple">
<li><p>복사한 각각의 노드에서 erlang.cookie 파일의 권한을 맞춰준다.</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>~# chown rabbitmq:rabbitmq /var/lib/rabbitmq/.erlang.cookie</p>
<p>~# chmod 400 /var/lib/rabbitmq/.erlang.cookie</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<ul class="simple">
<li><p>모든 노드에서 rabbitmq-server 서비스를 시작/활성화 시킨다.</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>~# systemctl enable rabbitmq-server.service</p>
<p>~# systemctl start rabbitmq-server.service</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<ul class="simple">
<li><p>첫번째 노드를 제외한 다른 노드에서 첫번째노드로 클러스터 가입을
시킨다.</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>~# rabbitmqctl stop_app</p>
<p>Stopping node <a class="reference external" href="mailto:rabbit&#37;&#52;&#48;NODE">rabbit<span>&#64;</span>NODE</a>… …done.</p>
<p>~# rabbitmqtl join_cluster -ram <a class="reference external" href="mailto:rabbit&#37;&#52;&#48;control1">rabbit<span>&#64;</span>control1</a></p>
<p>~# rabbitmqctl start_app</p>
<p>Starting node <a class="reference external" href="mailto:rabbit&#37;&#52;&#48;NODE">rabbit<span>&#64;</span>NODE</a> … …done.</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<ul class="simple">
<li><p>클러스터 상태 확인</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;control1">root<span>&#64;</span>control1</a> ~]# rabbitmqctl cluster_status</p>
<p>Cluster status of node <a class="reference external" href="mailto:rabbit&#37;&#52;&#48;control1">rabbit<span>&#64;</span>control1</a></p>
<p>[{nodes,[{disc,[<a class="reference external" href="mailto:rabbit&#37;&#52;&#48;control1">rabbit<span>&#64;</span>control1</a>,rabbit&#64;control2]}]},</p>
<p>{running_nodes,[<a class="reference external" href="mailto:rabbit&#37;&#52;&#48;control2">rabbit<span>&#64;</span>control2</a>,rabbit&#64;control1]},</p>
<p>{cluster_name,&lt;&lt;”<a class="reference external" href="mailto:rabbit&#37;&#52;&#48;control2">rabbit<span>&#64;</span>control2</a>”&gt;&gt;},</p>
<p>{partitions,[]},</p>
<p>{alarms,[<a class="reference external" href="mailto:{rabbit&#37;&#52;&#48;control2">{rabbit<span>&#64;</span>control2</a>,[]},{<a class="reference external" href="mailto:rabbit&#37;&#52;&#48;control1">rabbit<span>&#64;</span>control1</a>,[]}]}]</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<ul class="simple">
<li><p>큐 대기열을 미러링 시켜서 ha 구성을 하기 위해서 정책을 만들어준다.</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>~# rabbitmqctl set_policy ha-all ‘^(?!amq\.).*’ ‘{“ha-mode”: “all”}’</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<section id="openstack-rabbitmq-durable-queue">
<h2>Openstack Rabbitmq Durable Queue<a class="headerlink" href="#openstack-rabbitmq-durable-queue" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>기존 세션 연결된 rabbitmq 가 죽을 때 미러링된 큐에 Failover 하기
위해서는 아래 옵션 적용한다.</p></li>
<li><p><strong>(주의) 이걸 쓰려면 모든 서비스에 이 옵션이 켜져야한다</strong></p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p># All of Openstack Service Conf</p>
<p>[oslo_messaging_rabbit]</p>
<p>amqp_durable_queues = true</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><div class="line-block">
<div class="line">단, 해당 옵션 적용 뒤에는 적용 전에 생성된 큐가 하나라도 있을 경우
에러가 발생하므로</div>
<div class="line">모든 큐를 제거해주어야 한다.</div>
</div>
</li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>~# rabbitmqctl stop_app</p>
<p>~# rabbitmqctl reset 기존 생성한 클러스터링 설정도 날라간다</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="pcs-corosync-pacemaker">
<h2>pcs/corosync/pacemaker 설치 구성<a class="headerlink" href="#pcs-corosync-pacemaker" title="Permalink to this headline">#</a></h2>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong># (공통) Control1, Control2</strong></p>
<p><strong>yum install -y pcs fence-agents-all</strong></p>
<p><strong>passwd hacluster # pcs 데몬에서 사용할 hacluster 계정 패스워드
설정</strong></p>
<p><strong>systemctl start pcsd.service</strong></p>
<p><strong>systemctl enable pcsd.service</strong></p>
<p><strong>pcs cluster auth control1 control2</strong></p>
<p><strong>systemctl enable pacemaker corosync</strong></p>
<p><strong>systemctl start pacemaker corosync</strong></p>
<p><strong># Control1 (Master)</strong></p>
<p><strong>pcs cluster setup –start –name openstack control1 control2</strong></p>
<p><strong>pcs status # 클러스터 상태 확인</strong></p>
<p><strong>pcs cluster start –all</strong></p>
<p><strong>pcs cluster start</strong></p>
<p><strong>pcs property set stonith-enabled=false; crm_verify -L -V</strong></p>
<p><strong># Control2 (Slave)</strong></p>
<p><strong>pcs property set stonith-enabled=false; crm_verify -L -V</strong></p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<ul class="simple">
<li><p><a href="#id44"><span class="problematic" id="id45">`오류! 하이퍼링크 참조가 잘못되었습니다. &lt;&gt;`__</span></a></p></li>
</ul>
<blockquote>
<div><p>Username : hacluster</p>
<a class="reference internal image-reference" href="_images/image6.png"><img alt="텍스트, 스크린샷, 모니터이(가) 표시된 사진 자동 생성된 설명" src="_images/image6.png" style="width: 5.52538in; height: 1.89371in;" /></a>
<a class="reference internal image-reference" href="_images/image7.png"><img alt="_images/image7.png" src="_images/image7.png" style="width: 5.71441in; height: 2.92878in;" /></a>
<a class="reference internal image-reference" href="_images/image8.png"><img alt="테이블이(가) 표시된 사진 자동 생성된 설명" src="_images/image8.png" style="width: 3.58885in; height: 6.18413in;" /></a>
</div></blockquote>
</section>
<section id="mariadb-galera-cluster">
<h2>Mariadb Galera Cluster<a class="headerlink" href="#mariadb-galera-cluster" title="Permalink to this headline">#</a></h2>
<ul>
<li><p>Mariadb 를 클러스터링해서 다중화 구성을 위해 galera cluster 를
사용한다.</p></li>
<li><p>Qurum 방식으로 노드를 늘려나가기 때문에 홀수로 구성</p></li>
<li><p><strong>!!! 주의 : 클러스터링된 노드들 중에서 하나의 노드로만 IO를
수행해야한다
따라서, haproxy 로 active-backup-backup 구성이 반강제된다.</strong></p>
<ol class="arabic">
<li><p class="rubric" id="configuration">Configuration</p>
</li>
</ol>
</li>
<li><div class="line-block">
<div class="line">Packstack 으로 설치할 경우 /etc/my.cnf.d/server.cnf 에 wsrep 옵션이
활성화 되어있다.</div>
<div class="line">이걸 주석 처리해주고 galera.cnf 를 수정한다.</div>
</div>
</li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong># /etc/my.cnf.d/server.cnf</strong></p>
<p>#wsrep_cluster_name = galera_cluster</p>
<p>#wsrep_provider = none</p>
<p>#wsrep_sst_auth = root:</p>
<p>#wsrep_sst_method = rsync</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong># /etc/my.cnf.d/galera.cnf</strong></p>
<p>[mysqld]</p>
<p>binlog_format=ROW</p>
<p>default-storage-engine=innodb</p>
<p>innodb_autoinc_lock_mode=2</p>
<p>bind-address=0.0.0.0</p>
<p>wsrep_on=ON</p>
<p>wsrep_provider=/usr/lib64/galera/libgalera_smm.so</p>
<p><strong>wsrep_cluster_name=”svdi-galeracluster”</strong></p>
<p><strong>wsr
ep_cluster_address=”gcomm://10.104.71.11,10.104.71.12,10.104.71.13”</strong></p>
<p><strong>wsrep_node_name=svdi-controller1</strong></p>
<p><strong>wsrep_node_address=10.104.71.11</strong></p>
<p>wsrep_slave_threads=1</p>
<p>wsrep_certify_nonPK=1</p>
<p>wsrep_max_ws_rows=131072</p>
<p>wsrep_max_ws_size=1073741824</p>
<p>wsrep_debug=0</p>
<p>wsrep_convert_LOCK_to_trx=0</p>
<p>wsrep_retry_autocommit=10</p>
<p>wsrep_auto_increment_control=1</p>
<p>wsrep_drupal_282555_workaround=0</p>
<p>wsrep_causal_reads=0</p>
<p>wsrep_notify_cmd=</p>
<p>wsrep_sst_method=rsync</p>
<p><strong>wsrep_sst_auth=root:sms980502!</strong></p>
<p>innodb_buffer_pool_size=8G</p>
<p>innodb_buffer_pool_instances=4</p>
</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><div class="line-block">
<div class="line">3대의 mariadb를 설정한 뒤에 1대에서 먼저 아래의 명령을 실행한다.</div>
<div class="line">~# galera_new_cluster</div>
</div>
</li>
<li><div class="line-block">
<div class="line">나머지 2대에서는 아래와 같이 서비스를 실행한다.</div>
<div class="line">~# systemctl start mariadb</div>
</div>
<ol class="arabic">
<li><p class="rubric" id="galera-cluster">Galera Cluster 상태 점검</p>
</li>
</ol>
</li>
<li><p>아래의 명령으로 Galera Cluster에 노드가 묶인 것을 확인할 수 있다.</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;svdi-controller1">root<span>&#64;</span>svdi-controller1</a> my.cnf.d]# mysql -uroot -e “show status like
‘wsrep_cluster_size’;”</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<tbody>
</tbody>
</table>
</div>
<p>| Variable_name | Value |</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<tbody>
</tbody>
</table>
</div>
<p>| wsrep_cluster_size | 3 |</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<tbody>
</tbody>
</table>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-odd"><td></td>
</tr>
</tbody>
</table>
</div>
<section id="mariadb-galera-cluster-recovery">
<h3>MariaDB Galera Cluster Recovery<a class="headerlink" href="#mariadb-galera-cluster-recovery" title="Permalink to this headline">#</a></h3>
<ul>
<li><p>클러스터링된 장비 3대가 한번에 재부팅 될 경우 자동으로 복구 되지
않는다.</p></li>
<li><div class="line-block">
<div class="line">/var/lib/mysql/grastate.dat 에서 seqno 로 마지막에 살아있는 노드를
순차적으로 서비스를</div>
<div class="line">기동할수도 있지만 속편한 방법은 그냥 다시 클러스터링을 묶어주는
것이다.</div>
</div>
</li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>~# systemctl stop mariadb 오래걸릴경우 mysql 프로세스를 찾아서 kill</p>
<p>~# rm -f /var/lib/mysql/grastate.dat</p>
<p>~# rm -f /var/lib/mysql/galera.cache</p>
<p>~# galera_new_cluster</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<section id="openstack-api-haproxy">
<h2>Openstack API HAProxy<a class="headerlink" href="#openstack-api-haproxy" title="Permalink to this headline">#</a></h2>
<blockquote>
<div><p>~# yum install -y keepalived haproxy</p>
</div></blockquote>
<ul class="simple">
<li><p>컨트롤러 HA 구성하고 Openstack API에 대해서 HAPROXY 처리를 해주지
않으면 VIP를 들고있는 컨트롤러에서 특정 서비스가 죽을 경우 해당
서비스는 사용할 수가 없다.</p></li>
<li><p>VD-i 운영에 지장없는 서비스를 제외하고 아래의 서비스만 haproxy에
등록하여 운영한다.</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Service</p></th>
<th class="head"><p>Port</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Kestone</p></td>
<td><p>5000</p></td>
</tr>
<tr class="row-odd"><td><p>Nova</p></td>
<td><p>8774,8778</p></td>
</tr>
<tr class="row-even"><td><p>Neutron</p></td>
<td><p>9696</p></td>
</tr>
<tr class="row-odd"><td><p>Cinder</p></td>
<td><p>8776</p></td>
</tr>
<tr class="row-even"><td><p>Rabbitmq</p></td>
<td><p>5672</p></td>
</tr>
<tr class="row-odd"><td><p>MariaDB</p></td>
<td><p>3306</p></td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><div class="line-block">
<div class="line">MariaDB가 설치 되지 않은 Network 노드 2대에 keepalived, haproxy 를
설치하여 운영한다.|</div>
<div class="line">(MariaDB가 3306을 열고있는데 haproxy에서 또 3306을 열수 없음. 둘
중에 하나 포트를 바꿀수는 있지만 그렇게 되면 피곤해진다…….)</div>
</div>
<ol class="arabic">
<li><p class="rubric" id="keepalived-configuration">Keepalived Configuration</p>
</li>
</ol>
</li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>#MASTER</strong></p>
<p><strong># /etc/keepalived/keepalived.conf</strong></p>
<p>global_defs {</p>
<p>notification_email {</p>
<p>}</p>
<p>smtp_server 127.0.0.1 # You can specifiy your own smtp server here</p>
<p>smtp_connect_timeout 15</p>
<p>}</p>
<p># Define the script used to check if haproxy is still working</p>
<p><strong># 3306 포트에 대한 헬스체크를 수행하는 스크립트인데 뭔가
부실하다..개선하자</strong></p>
<p><strong># haproxy 프로세스를 다 죽여버리면 LBaasV2 가 같이
죽어버릴수도있다</strong></p>
<p>vrrp_script chk_haproxy {</p>
<p>#script “killall -0 haproxy”</p>
<p>script “nc -z 127.0.0.1 3306”</p>
<p>interval 2</p>
<p>weight 2</p>
<p>}</p>
<p># Configuation for the virtual interface</p>
<p>vrrp_instance VI_1 {</p>
<p>interface bond0</p>
<p>state MASTER</p>
<p>priority 101</p>
<p>virtual_router_id 51</p>
<p>smtp_alert # Activate email notifications</p>
<p>authentication {</p>
<p>auth_type PASS</p>
<p>auth_pass myPassw0rd # Set this to some secret phrase</p>
<p>}</p>
<p># The virtual ip address shared between the two loadbalancers</p>
<p>virtual_ipaddress {</p>
<p>10.104.102.23</p>
<p>}</p>
<p># Use the script above to check if we should fail over</p>
<p>track_script {</p>
<p>chk_haproxy</p>
<p>}</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>#SLAVE</strong></p>
<p><strong># /etc/keepalived/keepalived.conf</strong></p>
<p>global_defs {</p>
<p>notification_email {</p>
<p>}</p>
<p>smtp_server 127.0.0.1 # You can specifiy your own smtp server here</p>
<p>smtp_connect_timeout 15</p>
<p>}</p>
<p># Define the script used to check if haproxy is still working</p>
<p>vrrp_script chk_haproxy {</p>
<p>#script “killall -0 haproxy”</p>
<p>script “nc -z 127.0.0.1 3306”</p>
<p>interval 2</p>
<p>weight 2</p>
<p>}</p>
<p># Configuation for the virtual interface</p>
<p>vrrp_instance VI_1 {</p>
<p>interface bond0</p>
<p>state BACKUP</p>
<p>priority 102</p>
<p>virtual_router_id 51</p>
<p>smtp_alert # Activate email notifications</p>
<p>authentication {</p>
<p>auth_type PASS</p>
<p>auth_pass myPassw0rd # Set this to some secret phrase</p>
<p>}</p>
<p># The virtual ip address shared between the two loadbalancers</p>
<p>virtual_ipaddress {</p>
<p>10.104.102.23</p>
<p>}</p>
<p># Use the script above to check if we should fail over</p>
<p>track_script {</p>
<p>chk_haproxy</p>
<p>}</p>
<p>}</p>
</td>
</tr>
</tbody>
</table>
</div>
<section id="haproxy-configuration">
<h3>Haproxy Configuration<a class="headerlink" href="#haproxy-configuration" title="Permalink to this headline">#</a></h3>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>global</p>
<p>log 127.0.0.1 local2</p>
<p>maxconn 65535</p>
<p>user root</p>
<p>group root</p>
<p>daemon</p>
<p>stats socket /var/run/haproxy.sock mode 600 level admin</p>
<p>defaults</p>
<p>log global</p>
<p>option redispatch</p>
<p>retries 3</p>
<p>timeout http-request 10s</p>
<p>timeout http-keep-alive 10s</p>
<p>timeout queue 1m</p>
<p>timeout connect 10s</p>
<p>timeout client 1m</p>
<p>timeout server 1m</p>
<p>timeout check 10s</p>
<p>balance roundrobin</p>
<p>frontend mysql_cluster_frontend</p>
<p>bind *:3306</p>
<p>mode tcp</p>
<p>option clitcpka</p>
<p>timeout client 3600s</p>
<p>option tcplog</p>
<p>default_backend galera_cluster_backend</p>
<p>backend galera_cluster_backend</p>
<p>mode tcp</p>
<p>option tcpka</p>
<p>timeout server 3600s</p>
<p>balance roundrobin</p>
<p>server control1 10.104.102.14:3306 check backup</p>
<p>server control2 10.104.102.15:3306 check weight 1</p>
<p>server network1 10.104.102.13:3306 check backup</p>
<p>listen stats 0.0.0.0:9000</p>
<p>mode http</p>
<p>log global</p>
<p>stats enable</p>
<p>stats refresh 5s</p>
<p>stats uri /stats</p>
<p>stats realm HAProxy\ Statistics</p>
<p>stats auth admin:myPassword</p>
<p>stats admin if TRUE</p>
<p>frontend keystone_front</p>
<p>mode http</p>
<p>http-request del-header X-Forwarded-Proto</p>
<p>option httplog</p>
<p>option forwardfor</p>
<p>http-request set-header X-Forwarded-Proto https if { ssl_fc }</p>
<p>bind *:5000</p>
<p>default_backend keystone_back</p>
<p>backend keystone_back</p>
<p>mode http</p>
<p>balance roundrobin</p>
<p>server control1 10.104.102.14:5000 check inter 2000 rise 2 fall 5</p>
<p>server control2 10.104.102.15:5000 check inter 2000 rise 2 fall 5</p>
<p>frontend neutron_front</p>
<p>mode http</p>
<p>http-request del-header X-Forwarded-Proto</p>
<p>option httplog</p>
<p>option forwardfor</p>
<p>maxconn 10000</p>
<p>http-request set-header X-Forwarded-Proto https if { ssl_fc }</p>
<p>bind *:9696</p>
<p>default_backend neutron_back</p>
<p>backend neutron_back</p>
<p>balance roundrobin</p>
<p>mode http</p>
<p>fullconn 5000</p>
<p>server control1 10.104.102.14:9696 check inter 2000 rise 2 fall 5</p>
<p>server control2 10.104.102.15:9696 check inter 2000 rise 2 fall 5</p>
<p>frontend cinder_front</p>
<p>mode http</p>
<p>http-request del-header X-Forwarded-Proto</p>
<p>option httplog</p>
<p>option forwardfor</p>
<p>http-request set-header X-Forwarded-Proto https if { ssl_fc }</p>
<p>bind *:8776</p>
<p>default_backend cinder_back</p>
<p>backend cinder_back</p>
<p>mode http</p>
<p>server control1 10.104.102.14:8776 check inter 2000 rise 2 fall 5</p>
<p>server control2 10.104.102.15:8776 check inter 2000 rise 2 fall 5</p>
<p>frontend nova_front</p>
<p>mode http</p>
<p>http-request del-header X-Forwarded-Proto</p>
<p>option httplog</p>
<p>option forwardfor</p>
<p>http-request set-header X-Forwarded-Proto https if { ssl_fc }</p>
<p>bind *:8774</p>
<p>default_backend nova_back</p>
<p>backend nova_back</p>
<p>mode http</p>
<p>balance roundrobin</p>
<p>server control1 10.104.102.14:8774 check inter 2000 rise 2 fall 5</p>
<p>server control2 10.104.102.15:8774 check inter 2000 rise 2 fall 5</p>
<p>frontend nova_placement_front</p>
<p>mode http</p>
<p>http-request del-header X-Forwarded-Proto</p>
<p>option httplog</p>
<p>option forwardfor</p>
<p>http-request set-header X-Forwarded-Proto https if { ssl_fc }</p>
<p>bind *:8778</p>
<p>default_backend nova_placement_back</p>
<p>backend nova_placement_back</p>
<p>mode http</p>
<p>balance roundrobin</p>
<p>server control1 10.104.102.14:8778 check inter 2000 rise 2 fall 5</p>
<p>server control2 10.104.102.15:8778 check inter 2000 rise 2 fall 5</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
</section>
<section id="ha-network">
<h1><strong>HA - Network 구성</strong><a class="headerlink" href="#ha-network" title="Permalink to this headline">#</a></h1>
<ul>
<li><p>네트워크 노드의 HA 는 Openstack Neutron의 Failover 기능을 사용한다.</p>
<ol class="arabic">
<li><p class="rubric" id="configuring-layer-3-high-availability-ha">Configuring Layer 3 high availability (HA)</p>
</li>
</ol>
</li>
<li><p>Controller</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong># /etc/neutron/neutron.conf</strong></p>
<p><strong>[DEFAULT]</strong></p>
<p><strong>l3_ha = True</strong></p>
<p><strong>max_l3_agents_per_router = 3</strong></p>
<p><strong>min_l3_agents_per_router = 3</strong></p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong># /etc/openstack-dashboard/local_settings</strong></p>
<p><strong># line:373</strong></p>
<p>OPENSTACK_NEUTRON_NETWORK = {</p>
<p>‘enable_distributed_router’: False,</p>
<p>‘enable_firewall’: False,</p>
<p><strong>‘enable_ha_router’: True,</strong></p>
<p>‘enable_lb’: True,</p>
<p>‘enable_quotas’: True,</p>
<p>‘enable_security_group’: True,</p>
<p>‘enable_vpn’: False,</p>
<p>‘profile_support’: None,</p>
<p>}</p>
</td>
</tr>
</tbody>
</table>
</div>
<section id="l3-ha">
<h2>L3 HA 구성 검증<a class="headerlink" href="#l3-ha" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>네트워크 노드에서 아래의 명령어로 활성화되어서 IP를 들고있는 물리적
노드를 찾는다.</p></li>
</ul>
<blockquote>
<div><p>~# ip netns</p>
<p>~# ip netns exec qrouter-dbecd93b-45c1-4445-a19f-86fd7bafe0b8 ip a</p>
</div></blockquote>
<ul>
<li><div class="line-block">
<div class="line">활성화되어있는 qrouter 에서 ha 포트의 링크를 다운 시키면 자동으로
다른 물리적 노드의 qrouter 가 IP를 가져오며 활성화된다. Failover 될
때 네트워크 단절 없이 ping 1개 빠지는 수준이므로 별로 걱정 안해도
된다.</div>
<div class="line">~# ip netns exec qrouter-dbecd93b-45c1-4445-a19f-86fd7bafe0b8 ip
link set ha-b32b8df3-9b down</div>
</div>
<ol class="arabic">
<li><p class="rubric" id="high-availability-for-dhcp">High-availability for DHCP</p>
</li>
</ol>
</li>
<li><p>Controller</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>#/etc/neutron/neutron.conf</strong></p>
<p>[DEFAULT]</p>
<p>dhcp_agents_per_network = 3</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="high-availability-for-lbaasv2">
<h2>High-availability for LBaasV2<a class="headerlink" href="#high-availability-for-lbaasv2" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Controller / Network</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong># /etc/neutron/neutron_lbaas.conf</strong></p>
<p>[DEFAULT]</p>
<p>allow_automatic_lbaas_agent_failover=True</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="nova-compute-evacute">
<h2>Nova-Compute Evacute<a class="headerlink" href="#nova-compute-evacute" title="Permalink to this headline">#</a></h2>
<ol class="arabic">
<li><p class="rubric" id="openstackstein-tuning-for-vd-i"><strong>Openstack(Stein) Tuning for VD-i</strong></p>
<ol class="arabic">
<li><p class="rubric" id="id10"><strong>성능 최적화 참고자료</strong></p>
</li>
</ol>
</li>
</ol>
<ul class="simple">
<li><p>아래의 표는 인텔에서 작성한 “Performance Optimization Study: China
Railway’s Ultra-large Scale OpenStack* Industry Cloud Based on
Intel® Architecture” 의 파라메터 조정 수치이며 VD-i에서 실제 적용된
항목은 마스킹 되어있다.</p></li>
</ul>
</section>
</section>
<section id="openstack">
<h1><strong>Openstack 실적용 튜닝 옵션</strong><a class="headerlink" href="#openstack" title="Permalink to this headline">#</a></h1>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 9%" />
<col style="width: 24%" />
<col style="width: 44%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Ser
vice</p></th>
<th class="head"><p>File</p></th>
<th class="head"><p>Parameters</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Keys
tone</p></td>
<td><p>/etc/keystone
/keystone.conf</p></td>
<td><p>[cache]</p>
<p>backend =
oslo_cache.memcache_pool</p>
<p>enabled = True</p>
<p>memcache_servers =
10.10.
20.11:11211,101020.11:11211</p>
</td>
<td><p>다중화된
컨트롤러에서
캐시를
공유하여
인증정보를
공유한다.
이렇게하면
401에러를
대부분 없앨
수 있다.</p></td>
</tr>
<tr class="row-odd"><td><p>(공
통)</p></td>
<td><p>conf 파일</p></td>
<td><p>[os
lo_messaging_notifications]</p>
<p>transport_url =
rabbit://open
stack:passwd&#64;control1:5672,
ope
nstack:passwd&#64;control2:5672</p>
<p>driver = noop</p>
</td>
<td><p>Rabbitmq 에
notification
드라이버를
제거함으로
부하를
줄인다.</p></td>
</tr>
<tr class="row-even"><td><p>(공
통)</p></td>
<td><p>conf 파일</p></td>
<td><p>[DEFAULT]</p>
<p>rpc_response_timeout=600</p>
</td>
<td><p>메시징큐
타임아웃
늘리기,
기본값 60으로
해당 시간내에
트랜잭션이
종료되지
않으면 작업이
실패한다.
볼륨생성등의
오래걸리는
작업 경우
이것 때문에
실패할 수
있으므로
늘려준다.</p></td>
</tr>
<tr class="row-odd"><td><p>Nova</p></td>
<td><p>/etc/
nova/nova.conf</p></td>
<td><p>[DEFAULT]</p>
<p><a href="#id46"><span class="problematic" id="id47">block_</span></a>
device_allocate_retries=100</p>
<p>block_device_a
llocate_retries_interval=10</p>
</td>
<td><p>볼륨 생성에
시간이
걸리므로
인스턴스 생성
시에 발생할
실패를
방지하기 위해
늘려준다.</p></td>
</tr>
<tr class="row-even"><td><p>Nova</p></td>
<td><p>/etc/
nova/nova.conf</p></td>
<td><p>[DEFAULT]</p>
<p>vif_plugging_is_fatal=false</p>
</td>
<td><p>인스턴스 생성
시 VIF 가
연결 완료
메시지가
없으면
인스턴스
생성이
실패하는데
연결안되는
경우도 없는데
메시지가
안와서
실패하니 그냥
꺼주자</p></td>
</tr>
<tr class="row-odd"><td><p>Nova</p></td>
<td><p>/etc/
nova/nova.conf</p></td>
<td><p>[libvirt]</p>
<p>disk_cac
hemodes=”network=writeback”</p>
<p>cpu_mode=host-passthrough</p>
</td>
<td><p>iscsi, ceph
같은 네트워크
연결 기반의
볼륨을 사용할
때 해당
옵션을
적용해준다.</p></td>
</tr>
<tr class="row-even"><td><p>Neu
tron</p></td>
<td><p>/etc/neutro
n/neutron.conf</p></td>
<td><p># Controller</p>
<p>agent_down_time=80</p>
<p># Network</p>
<p>[agent]</p>
<p>report_interval=10</p>
</td>
<td><p>neutron-agent
들에 대하여
헬스체크
타임아웃
설정, L3 같은
경우는 즉시
Failover 되며
이 옵션으로
제일 영향
많은 부분은
LBaaSV2 로
짧아질 수록
Failover
복구가
빨라진다.
다만 너무
줄이면
안되므로
주의가
필요하다.</p></td>
</tr>
<tr class="row-odd"><td><p>(공
통)</p></td>
<td><p>conf 파일</p></td>
<td><p>[database]</p>
<p>connection_recycle_time =
10</p>
<p>max_pool_size = 1</p>
<p>max_retries = -1</p>
</td>
<td><p>connection
_recycle_time</p>
<ul class="simple">
<li><p>이</p></li>
</ul>
<p>시간(초)보다
오래 연결
풀에 있었던
연결은 다음에
풀에서
체크아웃할 때
새 연결로
바뀝니다.</p>
<p>max_pool_size</p>
<ul class="simple">
<li><p>풀에서 열린</p></li>
</ul>
<p>상태로 유지할
최대 SQL 연결
수입니다.
값을 0으로
설정하면
제한이 없음을
나타냅니다.</p>
<p>max_retires</p>
<ul class="simple">
<li><p>시작 중</p></li>
</ul>
<p>최대
데이터베이스
연결 재시도
횟수입니다.
무한 재시도
횟수를
지정하려면
-1로
설정하십시오.</p>
</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="bios-os-raid">
<h1><strong>기타 튜닝 - BIOS, OS, RAID 등</strong><a class="headerlink" href="#bios-os-raid" title="Permalink to this headline">#</a></h1>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 36%" />
<col style="width: 29%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>C
ategory</p></th>
<th class="head"><p>Parameters/Command</p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>BIOS</p></td>
<td><p>Turbo-Boost</p></td>
<td><p>Enable</p></td>
<td><ul class="simple">
<li></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>HOST
SYSTEM</p></td>
<td><p>tuned-adm</p></td>
<td><p>virtual-host</p></td>
<td><p>Compute-node</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>cpupower</p></td>
<td><p>frequency-set -g
performance</p></td>
<td></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>/sys/devices/sy
stem/cpu/cpufreq/boost</p></td>
<td><p>1</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>RAID</p></td>
<td><p>Write Policy</p></td>
<td><p>Forced WriteBack</p></td>
<td><ul class="simple">
<li></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td></td>
<td><p>Read Policy</p></td>
<td><p>ReadAhead</p></td>
<td></td>
</tr>
<tr class="row-even"><td></td>
<td><p>Cache Policy</p></td>
<td><p>Direct</p></td>
<td></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>Write Cache</p></td>
<td><p>No</p></td>
<td></td>
</tr>
<tr class="row-even"><td></td>
<td><p>Disk Cache Policy</p></td>
<td><p>Enabled</p></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<ol class="arabic">
<li><p class="rubric" id="troubole-shootingstein"><strong>Troubole Shooting(Stein)</strong></p>
<ol class="arabic">
<li><p class="rubric" id="id11">호스트 서버가 모두 종료될 경우</p>
</li>
</ol>
</li>
</ol>
<ol class="arabic">
<li><p>모든 서버 재기동</p></li>
<li><div class="line-block">
<div class="line">MariaDB를 갖고 있는 서버에서 아래의 절차를 진행한다.</div>
<div class="line">(example)</div>
<div class="line">Controller#1 - MariaDB#1</div>
<div class="line">Controller#2 - MariaDB#2</div>
<div class="line">Network#1 - MariaDB#3</div>
</div>
</li>
</ol>
<div class="line-block">
<div class="line"># MariaDB#1</div>
<div class="line">systemctl stop mariadb</div>
<div class="line">rm -f /var/lib/mysql/galera.cache</div>
<div class="line">rm -f /var/lib/mysql/grastate.dat</div>
<div class="line">galera_new_cluster</div>
</div>
<p># MariaDB#2 , MariaDB#3</p>
<div class="line-block">
<div class="line">systemctl stop mariadb</div>
<div class="line">rm -f /var/lib/mysql/galera.cache</div>
<div class="line">rm -f /var/lib/mysql/grastate.dat</div>
<div class="line">systemctl start mariadb</div>
</div>
<ol class="arabic simple" start="3">
<li><p>Controller #1, #2 에서 아래의 명령어로 오픈스택 서비스를 재기동한다.</p></li>
</ol>
<div class="line-block">
<div class="line">~# source /root/keystonerc_admin</div>
<div class="line">~# openstack-service restart</div>
</div>
<ol class="arabic simple" start="4">
<li><p>아래의 명령어로 Openstack 서비스를 점검한다.</p></li>
</ol>
<p>~# openstack compute service list</p>
<p>~# openstack volume service list</p>
<p>~# openstack network agent list</p>
<ol class="arabic simple" start="5">
<li><p>VD-i MGMT 환경을 재기동한다.</p></li>
</ol>
<ul class="simple">
<li><p>MariaDB 인스턴스 3개를 먼저 기동하여 위의 MariaDB 복구 절차에 따라
복구 진행</p></li>
<li><p>Broker #1, #2 및 VSMetric 인스턴스 재기동</p></li>
<li><p>Broker 인스턴스에 접속하여 아래와 같이 포트 오픈 여부를 확인한다.</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference external" href="mailto:root&#37;&#52;&#48;vd-i-broker2">root<span>&#64;</span>vd-i-broker2</a>:/somansa/vdi/vsmgmt# netstat -ntlp</p>
<p>Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program
name</p>
<p>tcp 0 0 0.0.0.0:9000 0.0.0.0:* LISTEN 1428/haproxy</p>
<p>tcp 0 0 0.0.0.0:3306 0.0.0.0:* LISTEN 1428/haproxy</p>
<p>tcp 0 0 127.0.0.1:7789 0.0.0.0:* LISTEN 1384/nginx: master</p>
<p>tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN 1384/nginx: master</p>
<p>tcp 0 0 127.0.0.1:7443 0.0.0.0:* LISTEN 1384/nginx: master</p>
<p>tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 1371/sshd</p>
<p>tcp 0 0 127.0.0.1:9080 0.0.0.0:* LISTEN 1384/nginx: master</p>
<p>tcp 0 0 0.0.0.0:90 0.0.0.0:* LISTEN 1384/nginx: master</p>
<p>tcp 0 0 0.0.0.0:443 0.0.0.0:* LISTEN 1384/nginx: master</p>
<p>tcp 0 0 0.0.0.0:9789 0.0.0.0:* LISTEN 1305/bin/socks5-bro</p>
<p>tcp 0 0 0.0.0.0:61790 0.0.0.0:* LISTEN 24006/node</p>
<p>tcp6 0 0 :::22 :::* LISTEN 1371/sshd</p>
<p>tcp6 0 0 :::8000 :::* LISTEN 24006/node</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<ul class="simple">
<li><p>오픈 되지 않은 포트에 대해서는 해당되는 서비스를 기동한다.</p></li>
</ul>
<blockquote>
<div><p>nginx : 80, 443, 7443, 90, 7789, 9080</p>
<p>mbroker : 9789</p>
<p>vsmgmt : 8000</p>
</div></blockquote>
</section>
<section id="openstack-service">
<h1>Openstack Service<a class="headerlink" href="#openstack-service" title="Permalink to this headline">#</a></h1>
<ul class="simple">
<li><p>/var/log 하위의 Openstack 서비스에서 공통적으로 발생하는 로그에 대한
조치</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 26%" />
<col style="width: 40%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>증상</p></th>
<th class="head"><p>원인</p></th>
<th class="head"><p>조치</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>connection pool
is full</p></td>
<td><p>대규모 클러스터 환경에서
발생하는 이슈로 python
에서 한번에 처리하는 pool
이 초과될 경우 발생</p></td>
<td><p>#/usr/lib/py
thon2.7/site-packages
/requests/adapters.py</p>
<p>DEFAULT_POOLSIZE =
1000</p>
</td>
</tr>
<tr class="row-odd"><td><p>AMQP server is
unreachable</p></td>
<td><p>Openstack서비스와
Rabbitmq 간의 통신 에러</p></td>
<td><p>통신구간 확인 및
rabbimq-server 서비스
점검</p></td>
</tr>
</tbody>
</table>
</div>
<ol class="arabic">
<li><p class="rubric" id="database">Database</p>
<ol class="arabic">
<li><p class="rubric" id="dbconnectionerror">DBConnectionError</p>
</li>
</ol>
</li>
</ol>
<ul class="simple">
<li><p>에러로그</p></li>
</ul>
<blockquote>
<div><div class="line-block">
<div class="line">RemoteError: Remote error: DBConnectionError
(pymysql.err.OperationalError)</div>
<div class="line">(2003, “Can’t connect to MySQL server on ‘[DATABASE_IP]’ ([Errno
111] ECONNREFUSED)”)</div>
</div>
</div></blockquote>
<ul>
<li><p>조치 : DATABASE_IP 로의 네트워크를 점검한다. 이상이 없다면 MariaDB의
커넥션 파라메터 점검한다.</p>
<ol class="arabic">
<li><p class="rubric" id="dberror">DBError</p>
</li>
</ol>
</li>
<li><p>에러로그</p></li>
</ul>
<blockquote>
<div><p>Remote error: DBError (pymysql.err.InternalError) (1129, u”Host
‘10.104.71.14’ is blocked because of many connection errors; unblock
with ‘mysqladmin flush-hosts’”)</p>
</div></blockquote>
<ul>
<li><div class="line-block">
<div class="line">조치</div>
<div class="line">DB 커넥션이 비정상 종료로 인해 IP가 차단된 것으로 MariaDB에
접속하여 ‘mysqladmin flush-hosts’ 명령어로 임시조치 이후 DB와
서비스 통신구간의 timeout 설정이 충분한지 확인한다.</div>
</div>
<ol class="arabic">
<li><p class="rubric" id="network-fail">Network Fail</p>
<ol class="arabic">
<li><p class="rubric" id="neutron-lbaasv2">Neutron LBaaSV2</p>
</li>
</ol>
</li>
</ol>
</li>
<li><p>LBaasSV2 서비스는 리눅스 네임스페이스에서 생성한 인터페이스를
사용하는데 삼중화 구성되어있는 네트워크 노드 1대에서만 구동해야하며
중복실행될 경우 동일한 IP가 같은 네트워크에 중복되어 라우팅 오류가
발생한다.</p></li>
<li><p>Openstack Dashboard &gt; 프로젝트 &gt; 네트워크 &gt; Neutron LoadBalancer 에서
로드밸런서의 UUID 를 확인한 다음 네트워크 서버에서 ip netns 명령어로
아래와 같이 세개의 노드 중에 하나만 있는지 확인한다. ( 다른 UUID 라면
무관하다 )</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;svdi-network1">root<span>&#64;</span>svdi-network1</a> ~]# ip netns</p>
<p>qdhcp-41b925ea-260c-4244-b160-576246f13c7a (id: 2)</p>
<p><strong>qlbaas-cded1ade-6e88-495a-9e64-d7b807775384 (id: 13)</strong></p>
<p>qrouter-623a85da-674f-4ed7-8cf1-610871b3c181 (id: 9)</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;svdi-network2">root<span>&#64;</span>svdi-network2</a> ~]# ip netns</p>
<p>qdhcp-a4ea948a-534d-4192-b55d-4480b545f393 (id: 4)</p>
<p>qrouter-623a85da-674f-4ed7-8cf1-610871b3c181 (id: 9)</p>
</td>
</tr>
<tr class="row-odd"><td><p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;svdi-network3">root<span>&#64;</span>svdi-network3</a> ~]# ip netns</p>
<p>qdhcp-0dfc3d78-3c03-4d58-aba8-cad71c64b84e (id: 12)</p>
<p>qrouter-623a85da-674f-4ed7-8cf1-610871b3c181 (id: 9)</p>
</td>
</tr>
</tbody>
</table>
</div>
<section id="proxy-arp">
<h2>Proxy-ARP<a class="headerlink" href="#proxy-arp" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Openstack 환경에 NAT를 사용하지 않고 VD에 실제 IP를 할당하기 위해서는
Proxy-arp 를 qrouter에적용해야한다.</p></li>
<li><p>문제발생시 Openstack 내부와 외부망이 통신이 불가능해진다.</p></li>
<li><p>아래의 스크립트를 실행하면 실행하는 호스트서버 내의 모든 qrouter 에
proxy-arp 를 활성화 한다.</p></li>
</ul>
<blockquote>
<div><div class="line-block">
<div class="line">Network #1, #2, #3</div>
<div class="line">~# sh /root/set_proxy_arp.sh</div>
</div>
</div></blockquote>
</section>
</section>
<section id="vd-instance-fail">
<h1>VD Instance Fail<a class="headerlink" href="#vd-instance-fail" title="Permalink to this headline">#</a></h1>
<ul>
<li><p>Nova 인스턴스에 대한 장애 상황에 따른 조치</p></li>
<li><p>Openstakc 대시보드 상 Status 가 Error 인 인스턴스는 이름을 클릭해서
해당 인스턴스 상태 변경에 대한 에러를 확인할 수 있다.</p>
<ol class="arabic">
<li><p class="rubric" id="instance-status-error">Instance Status - Error</p>
</li>
</ol>
</li>
</ul>
<ol class="arabic">
<li><p>Openstack Project에 할당된 Quata(인스턴스/볼륨/네트워크포트)가
초과되었는지 확인한다.</p></li>
<li><div class="line-block">
<div class="line">Block Device Allocation Failed : 볼륨 생성 시간이 MessagingQueue
Timeout 보다 오래 걸려 발생하므로</div>
<div class="line">볼륨 생성에 이상이 없는지, /etc/nova/nova.conf 에
rpc_response_timeout 이 600 이상인지 확인한다.</div>
</div>
</li>
</ol>
<ul class="simple">
<li><p>스냅샷 기반에서 생성할 경우 이런 장애는 거의 발생하지 않는다.</p></li>
<li><p>Error 상태인 VD (인스턴스)의 데이터를 반드시 복구해야 하는 경우</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>전제조건 : 볼륨이 깨졌거나 없다면 방법이 없다.</p>
<ol class="arabic simple">
<li><p>인스턴스를 제거할 경우 볼륨이 같이 사라질 수 있으므로 해당 볼륨의
스냅샷을 생성한다.</p></li>
<li><p>사용자 VD를 새로 생성하던가 재생성을 진행한다.</p></li>
<li><p>스냅샷에서 볼륨을 생성한다음 볼륨&gt;연결관리 기능으로 볼륨을 새로
생성한 VD에 연결한다.</p></li>
<li><p>재생성한 VD에서 추가드라이브로 확인할 수 있다.</p></li>
</ol>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<section id="virtualinterfacecreateexception">
<h2>VirtualInterfaceCreateException<a class="headerlink" href="#virtualinterfacecreateexception" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>에러로그</p></li>
</ul>
<blockquote>
<div><p>VirtualInterfaceCreateException</p>
</div></blockquote>
<ul>
<li><div class="line-block">
<div class="line">조치</div>
<div class="line">1) 인스턴스에 할당할 가상인터페이스 생성 실패로 Controller 노드의
neutron-server 서비스 상태 또는 통신 상태를 점검한다.</div>
<div class="line">2) 할당할 Private Network 에서 포트 Quata 가 초과 되었는지 임의로
포트생성이 가능한지 확인한다.</div>
</div>
</li>
</ul>
<ol class="arabic" start="2">
<li><p class="rubric" id="openstack-wallaby-kolla-ansible"><strong>Openstack - Wallaby ( Kolla-Ansible )</strong></p>
<ol class="arabic">
<li><p class="rubric" id="id12"><strong>기본요구사항</strong></p>
<ol class="arabic">
<li><p class="rubric" id="id13"><strong>운영체제</strong></p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<ul>
<li><p>OS : Ubuntu 20.04.3 LTS</p></li>
<li><p>Kernel : 5.4.0-113-generic</p>
<ol class="arabic">
<li><p class="rubric" id="id14"><strong>Openstack</strong></p>
</li>
</ol>
</li>
<li><p>Wallaby : Kolla-ansible 중에서 릴리즈 이후 1년 이상 경과되어 안정화
되었으리라 판단되는 버전</p>
<ol class="arabic">
<li><p class="rubric" id="kolla-ansible"><strong>Kolla-ansible</strong></p>
</li>
</ol>
</li>
<li><p>ansible : 2.9</p></li>
<li><p>kolla-ansible : stable/wallaby</p>
<ol class="arabic">
<li><p class="rubric" id="id15"><strong>사전준비</strong></p>
<ol class="arabic">
<li><p class="rubric" id="bond"><strong>Bond 인터페이스 구성</strong></p>
</li>
</ol>
</li>
</ol>
</li>
<li><p>Kolla-ansible 로 배포할 때에 인터페이스명을 지정을 하는데 장비별로
원하는 인터페이스 이름이 다르면 배포가 되지 않기 때문에 bond
인터페이스를 생성해서 할당하는게 수월하다.</p></li>
</ul>
<blockquote>
<div><p># Example</p>
<p>MGMT – bond0</p>
<p>External – bondex</p>
<p>API – bond10</p>
<p>Tunnel – bond20</p>
<p>CephCluster – bond30</p>
</div></blockquote>
</section>
</section>
<section id="id16">
<h1><strong>OS 환경 설정</strong><a class="headerlink" href="#id16" title="Permalink to this headline">#</a></h1>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong># root 비밀번호 설정 후, root로 접속</strong></p>
<p>sudo passwd root</p>
<p><strong># 방화벽 해제</strong></p>
<p>ufw disable</p>
<p><strong># ssh root 접속 허용</strong></p>
<p>sed -i ‘s/#PermitRootLogin prohibit-password/PermitRootLogin yes/g’
/etc/ssh/sshd_config</p>
<p>systemctl restart sshd</p>
<p><strong># 호스트네임 설정</strong></p>
<p>hostnamectl set-hostname “HOSTNAME”</p>
<p><strong># 관련 패키지 및 유틸리티 설치</strong></p>
<p>apt-get update -y</p>
<p>apt-get install -y vim wget curl net-tools git tmux tcpdump ifenslave
ethtool</p>
<p><strong># Domain-Query 서비스 중지 및 비활성화</strong></p>
<p>systemctl stop systemd-resolved.service</p>
<p>systemctl disable systemd-resolved.service</p>
<p>rm -rf /etc/resolv.conf</p>
<p>echo “nameserver 8.8.8.8” &gt; /etc/resolv.conf</p>
<p><strong># 호스트 파일 수정</strong></p>
<p>cat &gt; /etc/hosts &lt;&lt;EOF</p>
<p>10.10.20.11 deploy</p>
<p>10.10.20.12 control1</p>
<p>10.10.20.13 control2</p>
<p>10.10.20.14 network1</p>
<p>10.10.20.15 compute1</p>
<p>10.10.20.16 compute2</p>
<p>10.10.20.17 storage1</p>
<p>10.10.20.18 storage2</p>
<p>10.10.20.19 storage3</p>
<p>EOF</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="id17">
<h1><strong>배포 서버의 공개키 배포</strong><a class="headerlink" href="#id17" title="Permalink to this headline">#</a></h1>
<ul>
<li><p>Deploy Node에서 Kolla-Ansible의 모든 Node에 대해 공개키를 등록하여
비밀번호 입력 없이 SSH 접속할 수 있도록 설정한다.</p>
<ol class="arabic">
<li><p class="rubric" id="id18"><strong>물리서버 구성</strong></p>
</li>
</ol>
</li>
</ul>
<a class="reference internal image-reference" href="_images/image9.png"><img alt="_images/image9.png" src="_images/image9.png" style="width: 6.75in; height: 3.36533in;" /></a>
</section>
<section id="deploy">
<h1><strong>Deploy 서버 구성</strong><a class="headerlink" href="#deploy" title="Permalink to this headline">#</a></h1>
<ul class="simple">
<li><p>시스템 패키지와의 충돌을 피하기 위해, Python 가상 환경을 사용하여
설치한다.</p></li>
<li><p>“pip install -U pip” 하지 않을 시, 아래의 ansible 설치가 실패하므로
주의한다.</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>apt install python3-dev libffi-dev gcc libssl-dev -y</p>
<p>apt install python3-venv -y</p>
<p>python3 -m venv /path/to/venv</p>
<p>source /path/to/venv/bin/activate</p>
<p>pip install -U pip</p>
<p>pip install git+https://github.com/ansible/ansible.git&#64;stable-2.9</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<section id="id19">
<h2>Kolla-Ansible 설치<a class="headerlink" href="#id19" title="Permalink to this headline">#</a></h2>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>pip install
git+https://opendev.org/openstack/kolla-ansible&#64;stable/wallaby</p>
<p>sudo mkdir -p /etc/kolla</p>
<p>sudo chown $USER:$USER /etc/kolla</p>
<p>cp -r /path/to/venv/share/kolla-ansible/etc_examples/kolla/*
/etc/kolla</p>
<p>cp /path/to/venv/share/kolla-ansible/ansible/inventory/* /root/</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="inventory">
<h2>Inventory 파일 수정<a class="headerlink" href="#inventory" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>아래의 6개의 필드에만 실제 호스트네임을 기재하면 된다.</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>[control]</strong></p>
<p>labvdi-control1</p>
<p>labvdi-control2</p>
<p>labvdi-control3</p>
<p><strong>[network]</strong></p>
<p>labvdi-control1</p>
<p>labvdi-control2</p>
<p>labvdi-control3</p>
<p><strong>[compute]</strong></p>
<p>labvdi-compute1</p>
<p>labvdi-compute2</p>
<p><strong>[monitoring]</strong></p>
<p>labvdi-deploy</p>
<p><strong>[storage]</strong></p>
<p>labvdi-storage1</p>
<p>labvdi-storage2</p>
<p>labvdi-storage3</p>
<p><strong>[deployment]</strong></p>
<p>labvdi-deploy</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<ul class="simple">
<li><p>inventory 파일이 등록된 호스트에 대한 통신을 아래의 명령어로
확인한다.</p></li>
</ul>
<blockquote>
<div><p><strong>~# ansible -i ~/multinode_test all -m ping</strong></p>
</div></blockquote>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>(venv) <a class="reference external" href="mailto:root&#37;&#52;&#48;labvdi-deploy">root<span>&#64;</span>labvdi-deploy</a>:~# ansible -i ~/multinode_test all -m ping</p>
<p><strong>[WARNING]: Invalid characters were found in group names but not
replaced, use -vvvv to see details</strong></p>
<p>labvdi-storage2 | SUCCESS =&gt; {</p>
<p>“ansible_facts”: {</p>
<p>“discovered_interpreter_python”: “/usr/bin/python3”</p>
<p>},</p>
<p>“changed”: false,</p>
<p>“ping”: “pong”</p>
<p>}</p>
<p>labvdi-storage3 | SUCCESS =&gt; {</p>
<p>“ansible_facts”: {</p>
<p>“discovered_interpreter_python”: “/usr/bin/python3”</p>
<p>},</p>
<p>“changed”: false,</p>
<p>“ping”: “pong”</p>
<p>}</p>
<p>labvdi-storage1 | SUCCESS =&gt; {</p>
<p>“ansible_facts”: {</p>
<p>“discovered_interpreter_python”: “/usr/bin/python3”</p>
<p>},</p>
<p>“changed”: false,</p>
<p>“ping”: “pong”</p>
<p>}</p>
<p>labvdi-control2 | SUCCESS =&gt; {</p>
<p>“ansible_facts”: {</p>
<p>“discovered_interpreter_python”: “/usr/bin/python3”</p>
<p>},</p>
<p>“changed”: false,</p>
<p>“ping”: “pong”</p>
<p>}</p>
<p>labvdi-control1 | SUCCESS =&gt; {</p>
<p>“ansible_facts”: {</p>
<p>“discovered_interpreter_python”: “/usr/bin/python3”</p>
<p>},</p>
<p>“changed”: false,</p>
<p>“ping”: “pong”</p>
<p>}</p>
<p>labvdi-deploy | SUCCESS =&gt; {</p>
<p>“ansible_facts”: {</p>
<p>“discovered_interpreter_python”: “/usr/bin/python3”</p>
<p>},</p>
<p>“changed”: false,</p>
<p>“ping”: “pong”</p>
<p>}</p>
<p>labvdi-compute2 | SUCCESS =&gt; {</p>
<p>“ansible_facts”: {</p>
<p>“discovered_interpreter_python”: “/usr/bin/python3”</p>
<p>},</p>
<p>“changed”: false,</p>
<p>“ping”: “pong”</p>
<p>}</p>
<p>labvdi-control3 | SUCCESS =&gt; {</p>
<p>“ansible_facts”: {</p>
<p>“discovered_interpreter_python”: “/usr/bin/python3”</p>
<p>},</p>
<p>“changed”: false,</p>
<p>“ping”: “pong”</p>
<p>}</p>
<p>labvdi-compute1 | SUCCESS =&gt; {</p>
<p>“ansible_facts”: {</p>
<p>“discovered_interpreter_python”: “/usr/bin/python3”</p>
<p>},</p>
<p>“changed”: false,</p>
<p>“ping”: “pong”</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="passwords-yml">
<h2>passwords.yml 생성<a class="headerlink" href="#passwords-yml" title="Permalink to this headline">#</a></h2>
<ul>
<li><p>아래의 명령으로 /etc/kolla/passwords.yml 파일을 생성해준다.
패스워드는 랜덤으로 자동생성된다.</p></li>
<li><div class="line-block">
<div class="line">실제 입력해야 하는 상황이 있는 아래의 대표 패스워드는 가급적
적당한걸로 기재한다.</div>
<div class="line">(수기 입력이 필요한 계정은 비밀번호 생성규칙에 맞는 문자열로
자동생성 비밀번호를 대체한다)</div>
</div>
</li>
</ul>
<blockquote>
<div><p>~# kolla-genpwd</p>
</div></blockquote>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>#/etc/kolla/passwords.yml</strong></p>
<p><strong>#line : 125</strong></p>
<p>database_password:</p>
<p><strong>#line : 141</strong></p>
<p>grafana_admin_password:</p>
<p><strong>#line: 156</strong></p>
<p>keystone_admin_password:</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="octavia">
<h2>Octavia 인증서 생성<a class="headerlink" href="#octavia" title="Permalink to this headline">#</a></h2>
<ul>
<li><div class="line-block">
<div class="line">Octavia에서 amphora 인스턴스에 접속할 수 있는 ssl 인증서를
생성한다.</div>
<div class="line">~# kolla-ansible octavia-certificates</div>
</div>
<ol class="arabic">
<li><p class="rubric" id="globals-yml">globals.yml 구성</p>
</li>
</ol>
</li>
<li><p>원본파일 :
/path/to/venv/share/kolla-ansible/etc_examples/kolla/globals.yml</p></li>
<li><p>packstack 기준으로는 answer.txt 파일 역할이다. 뭐하나 수정하면 손이
많이 가므로 아래의 파일 기반으로 작업하자.</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>kolla_base_distro: “ubuntu”</p>
<p>kolla_install_type: “source”</p>
<p>openstack_release: “wallaby”</p>
<p>kolla_internal_vip_address: “10.10.20.30”</p>
<p><strong># Openstack Dashboard IP / OpenstackAPI Public IP</strong></p>
<p>kolla_external_vip_address: “10.120.0.30”</p>
<p>network_interface: “bond20”</p>
<p>kolla_external_vip_interface: “bond10”</p>
<p>api_interface: “bond20”</p>
<p>neutron_external_interface: “bondex”</p>
<p>tunnel_interface: “bond30”</p>
<p>neutron_plugin_agent: “openvswitch”</p>
<p>neutron_ipam_driver: “internal”</p>
<p>octavia_network_interface: “bond10”</p>
<p>enable_neutron_provider_networks: “no”</p>
<p>enable_container_healthchecks: “yes”</p>
<p>default_container_healthcheck_interval: 30</p>
<p>default_container_healthcheck_timeout: 30</p>
<p>default_container_healthcheck_retries: 3</p>
<p>default_container_healthcheck_start_period: 5</p>
<p>enable_openstack_core: “yes”</p>
<p>enable_haproxy: “yes”</p>
<p>enable_keystone: “yes”</p>
<p>enable_mariadb: “yes”</p>
<p>enable_memcached: “yes”</p>
<p>enable_neutron: “yes”</p>
<p>enable_nova: “yes”</p>
<p>enable_central_logging: “yes”</p>
<p>enable_glance: “yes”</p>
<p>enable_cinder: “yes”</p>
<p>enable_cinder_backup: “yes”</p>
<p>enable_rabbitmq: “yes”</p>
<p>enable_fluentd: “no”</p>
<p>enable_prometheus: “no”</p>
<p>enable_grafana: “yes”</p>
<p>enable_heat: “no”</p>
<p>enable_horizon: “yes”</p>
<p>enable_octavia: “yes”</p>
<p>enable_kibana: “no”</p>
<p>enable_elasticsearch: “no”</p>
<p>enable_swift: “no”</p>
<p>enable_chrony: “yes”</p>
<p>keystone_token_provider: ‘fernet’</p>
<p>keystone_admin_user: “admin”</p>
<p>keystone_admin_project: “admin”</p>
<p>nova_compute_virt_type: “kvm”</p>
<p>nova_console: “novnc”</p>
<p>prometheus_port: “9283”</p>
<p>prometheus_node_exporter_port: “9099”</p>
<p>enable_prometheus_server: “yes”</p>
<p>enable_prometheus_alertmanager: “yes”</p>
<p>enable_prometheus_node_exporter: “yes”</p>
<p>enable_prometheus_cadvisor: “yes”</p>
<p>enable_prometheus_haproxy_exporter: “yes”</p>
<p>enable_prometheus_mysqld_exporter: “yes”</p>
<p>enable_prometheus_ceph_mgr_exporter: “yes”</p>
<p>enable_prometheus_openstack_exporter: “yes”</p>
<p>enable_prometheus_libvirt_exporter: “yes”</p>
<p>enable_horizon_octavia: “yes”</p>
<p>octavia_auto_configure: “yes”</p>
<p>octavia_certs_country: KR</p>
<p>octavia_certs_state: Seoul</p>
<p>octavia_certs_organization: OpenStack</p>
<p>octavia_certs_organizational_unit: Octavia</p>
<p>octavia_amp_flavor:</p>
<p>name: “amphora”</p>
<p>flavorid: 100</p>
<p>is_public: no</p>
<p>vcpus: 2</p>
<p>ram: 2048</p>
<p>disk: 5</p>
<p>octavia_amp_network:</p>
<p>name: lb-mgmt-net</p>
<p>provider_network_type: “vxlan”</p>
<p>shared: true</p>
<p>subnet:</p>
<p>name: lb-mgmt-subnet</p>
<p>cidr: “{{ octavia_amp_network_cidr }}”</p>
<p>no_gateway_ip: no</p>
<p>enable_dhcp: “yes”</p>
<p>gateway_ip: “20.0.0.1”</p>
<p>allocation_pool_start: “20.0.0.101”</p>
<p>allocation_pool_end: “20.0.0.200”</p>
<p>octavia_amp_network_cidr: “20.0.0.0/24”</p>
<p>octavia_amp_image_tag: “amphora”</p>
<p>octavia_loadbalancer_topology: “ACTIVE_STANDBY”</p>
<p>external_ceph_cephx_enabled: “yes”</p>
<p>glance_backend_ceph: “yes”</p>
<p>cinder_backend_ceph: “yes”</p>
<p>nova_backend_ceph: “no”</p>
<p>ceph_glance_keyring: “ceph.client.glance.keyring”</p>
<p>ceph_glance_user: “glance”</p>
<p>ceph_glance_pool_name: “images”</p>
<p>ceph_cinder_keyring: “ceph.client.cinder.keyring”</p>
<p>ceph_cinder_user: “cinder”</p>
<p>ceph_cinder_pool_name: “volumes”</p>
<p>ceph_cinder_backup_keyring: “ceph.client.cinder-backup.keyring”</p>
<p>ceph_cinder_backup_user: “cinder-backup”</p>
<p>ceph_cinder_backup_pool_name: “backups”</p>
<p>cinder_backup_driver: “ceph”</p>
<p>ceph_nova_keyring: “ceph.client.cinder.keyring”</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="overcloud">
<h2>OverCloud 필수 패키지 배포<a class="headerlink" href="#overcloud" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>각 노드에 컨테이너를 실행시키기 위한 런타임 (Docker) 패키지들이
배포된다.</p></li>
<li><p>또한, 해당 배포를 통해 스토리지 노드에서 Ceph Cluster를 배포하기 위한
조건도 충족된다.</p></li>
</ul>
<blockquote>
<div><p><strong>~# kolla-ansible -i ~/multinode bootstrap-servers</strong></p>
</div></blockquote>
</section>
<section id="ceph-cluster-1">
<span id="id20"></span><h2>Ceph Cluster 구성<a class="headerlink" href="#ceph-cluster-1" title="Permalink to this headline">#</a></h2>
<ul>
<li><p><strong>Cephadm 으로 진행하는 배포작업은 Storage1 노드에서 진행한다.</strong></p>
<ol class="arabic">
<li><p class="rubric" id="cephadm-ceph-cluster">Cephadm 패키지 설치 및 Ceph Cluster 배포</p>
</li>
</ol>
</li>
<li><p>globals.yml 에 ceph 관련 설정이 있으므로 Overcloud에 openstack
배포전에 ceph 관련 설정 및 배포를 해주어야한다.</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p># Storage1</p>
<p># Create /root/ceph.conf</p>
<p>[global]</p>
<p>public network = 10.10.30.0/24 // Tunnel Network 대역</p>
<p>cluster network = 10.10.40.0/24 // Cluster Network 대역</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>apt install -y cephadm</p>
<p>cephadm bootstrap –mon-ip 10.10.30.17 -c /root/ceph.conf
–skip-monitoring-stack</p>
<p>cephadm shell – ceph -s</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<ul class="simple">
<li><p>배포완료 후에는 대시보드로 접속하여 패스워드를 수정해준다.</p></li>
</ul>
<blockquote>
<div><p><a class="reference external" href="https://10.10.30.17:8443">https://10.10.30.17:8443</a></p>
<a class="reference internal image-reference" href="_images/image10.png"><img alt="_images/image10.png" src="_images/image10.png" style="width: 3.82914in; height: 2.79448in;" /></a>
</div></blockquote>
<ul class="simple">
<li><p>storage1에서 다른 스토리지 노드로 공개키를 배포한다.</p></li>
</ul>
<blockquote>
<div><p><strong>~# ssh-copy-id -f -i /etc/ceph/ceph.pub root&#64;10.10.30.18</strong></p>
<p><strong>~# ssh-copy-id -f -i /etc/ceph/ceph.pub root&#64;10.10.30.19</strong></p>
</div></blockquote>
<ul class="simple">
<li><p>다른 스토리지노드를 Cluster 에 등록한다.</p></li>
</ul>
<p><strong>~# cephadm shell – ceph orch host add storage1 10.10.30.17 _admin</strong></p>
<p><strong>~# cephadm shell – ceph orch host add storage2 10.10.30.18 _admin</strong></p>
<p><strong>~# cephadm shell – ceph orch host add storage3 10.10.30.19 _admin</strong></p>
<p><strong>~# cephadm shell – ceph orch host ls</strong></p>
<p><strong>~# cephadm shell – ceph -s</strong></p>
<section id="ceph-osd">
<h3>Ceph OSD 생성<a class="headerlink" href="#ceph-osd" title="Permalink to this headline">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>Ceph DashBoard에 접속하여 좌측 Cluster 탭의 OSDs 항목을 클릭한다.</p></li>
<li><p>Create 버튼을 누르고 Primary devices 클릭하면 Storage 노드에</p></li>
</ul>
<p>연결되어 있는 HDD, SSD 디스크들이 보일텐데 해당 디스크를 필터
(Model명 필수)를 통해 선택하고 생성한다.</p>
<a class="reference internal image-reference" href="_images/image11.png"><img alt="_images/image11.png" src="_images/image11.png" style="width: 4.33572in; height: 2.43974in;" /></a>
<a class="reference internal image-reference" href="_images/image12.png"><img alt="텍스트이(가) 표시된 사진 자동 생성된 설명" src="_images/image12.png" style="width: 3.35759in; height: 2.7356in;" /></a>
</div></blockquote>
</section>
<section id="ceph-pool">
<h3>Ceph Pool 생성<a class="headerlink" href="#ceph-pool" title="Permalink to this headline">#</a></h3>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>cephadm shell – ceph osd pool create volumes // Cinder-Volume용</p>
<p>cephadm shell – ceph osd pool create images // Glance용</p>
<p>cephadm shell – ceph osd pool create backups // Cinder-Backup용</p>
<p>cephadm shell – rbd pool init volumes</p>
<p>cephadm shell – rbd pool init images</p>
<p>cephadm shell – rbd pool init backups</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="ceph-pool-keyring-deploy">
<h3>Ceph Pool Keyring 생성 및 Deploy 노드로 복사<a class="headerlink" href="#ceph-pool-keyring-deploy" title="Permalink to this headline">#</a></h3>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>mkdir -p ~/ceph-auth</p>
<p>cephadm shell – ceph auth get-or-create client.glance mon ‘profile
rbd’ osd ‘profile rbd pool=images’ mgr ‘profile rbd pool=images’</p>
<p>cephadm shell – ceph auth get-or-create client.cinder mon ‘profile
rbd’ osd ‘profile rbd pool=volumes, profile rbd-read-only
pool=images’ mgr ‘profile rbd pool=volumes’</p>
<p>cephadm shell – ceph auth get-or-create client.cinder-backup mon
‘profile rbd’ osd ‘profile rbd pool=backups’ mgr ‘profile rbd
pool=backups’</p>
<p>cephadm shell – ceph auth get-or-create client.glance | tee
~/ceph-auth/ceph.client.glance.keyring</p>
<p>cephadm shell – ceph auth get-or-create client.cinder | tee
~/ceph-auth/ceph.client.cinder.keyring</p>
<p>cephadm shell – ceph auth get-or-create client.cinder-backup | tee
~/ceph-auth/ceph.client.cinder-backup.keyring</p>
<p>cat /etc/ceph/ceph.conf | tee ~/ceph-auth/ceph.conf</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong># Deploy</strong></p>
<p>mkdir -p /etc/kolla/config/glance</p>
<p>mkdir -p /etc/kolla/config/cinder/cinder-volume</p>
<p>mkdir -p /etc/kolla/config/cinder/cinder-backup</p>
<p>mkdir -p /etc/kolla/config/nova</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong># Storage1</strong></p>
<p>scp ~/ceph-auth/ceph.conf deploy:/etc/kolla/config/glance/</p>
<p>scp ~/ceph-auth/ceph.client.glance.keyring
deploy:/etc/kolla/config/glance/</p>
<p>scp ~/ceph-auth/ceph.conf deploy:/etc/kolla/config/cinder/</p>
<p>scp ~/ceph-auth/ceph.client.cinder*
deploy:/etc/kolla/config/cinder/cinder-volume/</p>
<p>scp ~/ceph-auth/ceph.client.cinder*
deploy:/etc/kolla/config/cinder/cinder-backup/</p>
<p>scp ~/ceph-auth/ceph.client.cinder.keyring
deploy:/etc/kolla/config/nova/</p>
</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="glance-conf">
<h3>glance.conf 생성<a class="headerlink" href="#glance-conf" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>glance.conf의 경우, Deploy Node에서 따로 생성해주어야 한다</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong># /etc/kolla/config/glance/glance.conf</strong></p>
<p>[GLOBAL]</p>
<p>show_image_direct_url = True</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
</section>
<section id="kolla-ansible-openstack-container">
<h1><strong>Kolla-Ansible Openstack container 배포</strong><a class="headerlink" href="#kolla-ansible-openstack-container" title="Permalink to this headline">#</a></h1>
<ul>
<li><div class="line-block">
<div class="line">배포환경 사전 점검</div>
<div class="line"><strong>~# kolla-ansible -i ~/multinode prechecks</strong></div>
</div>
</li>
<li><div class="line-block">
<div class="line">배포</div>
<div class="line"><strong>~# kolla-ansible -i ~/multinode deploy</strong></div>
</div>
</li>
<li><ol class="arabic">
<li><p class="rubric" id="openstack-cli"><strong>Openstack CLI 설치</strong></p>
</li>
</ol>
</li>
<li><p>Kolla-ansible 에서는 openstack 클라이언트가 안들어있으므로 수동으로
설치를 해야한다.</p></li>
<li><p>아래 과정을 진행하고 나면 /path/to/venv/bin/activate 와
/etc/kolla/admin-openrc.sh 파일을 source 명령어로 import 해준뒤에
openstack 명령어를 사용할 수 있다.</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>#Deploy Node</strong></p>
<p>source /path/to/venv/bin/activate</p>
<p>pip install python-openstackclient -c
<a class="reference external" href="https://releases.openstack.org/constraints/upper/wallaby">https://releases.openstack.org/constraints/upper/wallaby</a></p>
<p>kolla-ansible post-deploy</p>
<p>source /etc/kolla/admin-openrc.sh</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<ol class="arabic">
<li><p class="rubric" id="id21"><strong>Octavia 로드밸런서 구성</strong></p>
<ol class="arabic">
<li><p class="rubric" id="amphora">Amphora 이미지</p>
</li>
</ol>
</li>
</ol>
<ul class="simple">
<li><p>Amphora 이미지는 빌드환경을 많이 타므로 보존한 qcow2 이미지를
활용하자.</p></li>
<li><p>[참고] Amphora 이미지 Build</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>sudo apt -y install debootstrap qemu-utils git kpartx</p>
<p>git clone <a class="reference external" href="https://opendev.org/openstack/octavia">https://opendev.org/openstack/octavia</a> -b wallaby</p>
<p>python3 -m venv dib-venv</p>
<p>source dib-venv/bin/activate</p>
<p>pip install diskimage-builder</p>
<p>cd octavia/diskimage-create</p>
<p>./diskimage-create.sh</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<ul class="simple">
<li><p>Amphora 이미지 업로드</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>source /etc/kolla/octavia-openrc.sh</p>
<p>openstack image create amphora-x64-haproxy.qcow2 \</p>
<p>–container-format bare –disk-format qcow2 \</p>
<p>–private –tag amphora –file amphora-x64-haproxy.qcow2 \</p>
<p>–property hw_architecture=’x86_64’ –property hw_rng_model=virtio</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<section id="id22">
<h2>Amphora 인스턴스 라우팅 설정<a class="headerlink" href="#id22" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>로드 밸런서가 제대로 작동하려면 Compute 노드에 VM으로 동작 중인
Amphora 인스턴스와Control Node에 컨테이너로 동작하는 Octavia
컨테이너간 통신을 해야 하는데 이를 위해서는 모든 Control Node에서
라우팅 설정을 해주어야 한다.</p></li>
</ul>
<blockquote>
<div><p><strong># 10.104.41.211 은 openstack network 에 생성한 router IP이다.</strong></p>
<p><strong># 가급적이면 lb-mgmt-net 네트워크 전용 라우터 하나 만들자.</strong></p>
<p><strong>~# route add -net 20.0.0.0/24 gw 10.104.41.211</strong></p>
</div></blockquote>
</section>
<section id="id23">
<h2>로드밸런서 생성<a class="headerlink" href="#id23" title="Permalink to this headline">#</a></h2>
<ul>
<li><div class="line-block">
<div class="line">Octavia 로드밸런서는 가용성존(AvailabilityZone)을 설정할 수 없다</div>
<div class="line">따라서 생성되어야 하는 하이퍼바이저를 제외한 다른 하이퍼바이저는
비활성화 후 진행한다.</div>
</div>
</li>
<li><div class="line-block">
<div class="line">접속하는 사용자의 실제 IP를 전달하기 위해서는 PROXY-PROTOCOL을
사용해야 하며</div>
<div class="line">PROXY헤더를 추가하기 위해서는 리스너를 CLI 로 생성해야 한다. 따라서
먼저 로드밸런서만 생성한다.</div>
</div>
</li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image13.png"><img alt="_images/image13.png" src="_images/image13.png" style="width: 4.64167in; height: 4.23712in;" /></a>
</div></blockquote>
</section>
<section id="id24">
<h2>리스너 생성<a class="headerlink" href="#id24" title="Permalink to this headline">#</a></h2>
<p>openstack loadbalancer listener create –name tcp-80 –protocol TCP
–protocol-port 80 svdi-broker-lb</p>
<p>openstack loadbalancer pool create –name http-proxy-pool –lb-algorithm
SOURCE_IP –listener tcp-80 –protocol PROXY</p>
<p>openstack loadbalancer listener create –name tcp-443 –protocol TCP
–protocol-port 443 svdi-broker-lb</p>
<p>openstack loadbalancer pool create –name https-proxy-pool
–lb-algorithm SOURCE_IP –listener tcp-443 –protocol PROXY</p>
<ol class="arabic" start="2">
<li><p class="rubric" id="id25">멤버 추가</p>
</li>
<li><p class="rubric" id="id26">상태모니터 생성</p>
</li>
</ol>
<ol class="arabic">
<li><p class="rubric" id="troubleshooting"><strong>TroubleShooting</strong></p>
<ol class="arabic">
<li><p class="rubric" id="openstack-ap">Openstack AP</p>
</li>
</ol>
</li>
</ol>
<ul class="simple">
<li><p>/var/log/kollla 하위의 Openstack AP 에서 발생하는 에러에 대한 조치</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 27%" />
<col style="width: 39%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>증상</p></th>
<th class="head"><p>원인</p></th>
<th class="head"><p>조치</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>VM 비정상 종료</p>
<p>/var/log/k
olla/nova-comput
e/novacomute.log</p>
<p>During
_sync_inst
ance_power_state
the DB
power_state (1)
does not match
the
vm_power_state
from the
hypervisor (4).
Updating
power_state in
the DB to match
the hypervisor.</p>
</td>
<td></td>
<td><p>/
etc/kolla/config/nova
/{HOSTNAME}/nova.conf</p>
<p>kolla-ansible -i
~/multinode -t nova
reconfigure</p>
<p>[DEFAULT]</p>
<p>sync_po
wer_state_interval=-1</p>
</td>
</tr>
</tbody>
</table>
</div>
<ol class="arabic" start="3">
<li><p class="rubric" id="openstack-configuration"><strong>Openstack Configuration</strong></p>
<ol class="arabic">
<li><p class="rubric" id="project"><strong>Project 생성</strong></p>
</li>
</ol>
</li>
</ol>
<ul class="simple">
<li><p>가용할 Project(=Tenant) 를 생성한다.</p></li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image14.png"><img alt="텍스트이(가) 표시된 사진 자동 생성된 설명" src="_images/image14.png" style="width: 4.43776in; height: 2.97066in;" /></a>
</div></blockquote>
<ul>
<li><div class="line-block">
<div class="line">프로젝트 멤버를 할당한다.</div>
<div class="line">admin의 경우 관리자 항목도 같이 볼 수 있도록 admin 권한도
추가해준다.</div>
</div>
</li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image15.png"><img alt="_images/image15.png" src="_images/image15.png" style="width: 4.50412in; height: 3.13558in;" /></a>
</div></blockquote>
<ul class="simple">
<li><p>“Qutas 수정” 항목에서 프로젝트에 필요한 리소스를 할당해준다.</p></li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image16.png"><img alt="_images/image16.png" src="_images/image16.png" style="width: 4.18313in; height: 3.93172in;" /></a>
<a class="reference internal image-reference" href="_images/image17.png"><img alt="텍스트이(가) 표시된 사진 자동 생성된 설명" src="_images/image17.png" style="width: 4.1895in; height: 2.03591in;" /></a>
<a class="reference internal image-reference" href="_images/image18.png"><img alt="_images/image18.png" src="_images/image18.png" style="width: 4.18506in; height: 3.04623in;" /></a>
</div></blockquote>
<ol class="arabic">
<li><p class="rubric" id="network"><strong>Network 설정</strong></p>
<ol class="arabic">
<li><p class="rubric" id="public"><strong>Public 네트워크 설정</strong></p>
</li>
</ol>
</li>
</ol>
<a class="reference internal image-reference" href="_images/image2.png"><img alt="테이블이(가) 표시된 사진 자동 생성된 설명" src="_images/image2.png" style="width: 4.38465in; height: 1.88684in;" /></a>
<ul class="simple">
<li><p>오픈스택에서 가장 상위에 위치하는 레이어인 Public 네트워크를 먼저
구성한다.</p></li>
<li><p>관리 &gt; 네트워크 항목에서 네트워크를 생성한다.</p></li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image19.png"><img alt="_images/image19.png" src="_images/image19.png" style="width: 4.75941in; height: 1.68121in;" /></a>
</div></blockquote>
<ul class="simple">
<li><p>프로젝트는 admin 이나 service 든 “공유”옵션을 켜기 때문에 상관없다.</p></li>
<li><p>Provider Network 는 설치할 때 지정한 Flat 을 선택해야한다.</p></li>
<li><p>물리적인 네트워크는 extnet이며 이 값은 아래의 파일에서 확인할 수
있다.</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong># answer.txt</strong></p>
<p>CONFIG_NEUTRON_OVS_EXTERNAL_PHYSNET=<strong>extnet</strong></p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong># Network Node</strong></p>
<p><strong>#/etc/neutron/plugins/ml2/openvswitch_agent.ini</strong></p>
<p>[ovs]</p>
<p>bridge_mappings=<strong>extnet</strong>:br-ex,physnet10:br-port,physnet1:br-pv</p>
</td>
</tr>
</tbody>
</table>
</div>
<ul class="simple">
<li><p>다른 테넌트(프로젝트)도 사용해야 하므로 공유를 켜주고
외부네트워크이기 때문에 외부네트워크 항목도 체크해준다.</p></li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image20.png"><img alt="_images/image20.png" src="_images/image20.png" style="width: 5.11019in; height: 5.659in;" /></a>
</div></blockquote>
<ul class="simple">
<li><p>Public Network 가 사용할 서브넷을 지정해준다.</p></li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image21.png"><img alt="텍스트이(가) 표시된 사진 자동 생성된 설명" src="_images/image21.png" style="width: 5.29516in; height: 3.76014in;" /></a>
</div></blockquote>
<ul class="simple">
<li><p>Public Network 에 사용할 Pool과 DNS를 지정해줄 수 있다.</p></li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image22.png"><img alt="텍스트이(가) 표시된 사진 자동 생성된 설명" src="_images/image22.png" style="width: 4.69532in; height: 3.95778in;" /></a>
</div></blockquote>
</section>
<section id="private">
<h2><strong>Private 네트워크 설정</strong><a class="headerlink" href="#private" title="Permalink to this headline">#</a></h2>
<ul>
<li><p>Private 네트워크는 환경에 따라 VD 인스턴스에 실제 IP를 할당하느냐
완전한 사설 네트워크를 만드느냐에 따라서 SNAT 활성화/비활성화 여부를
선택한다.</p></li>
<li><p>요약해서 100개 VD인스턴스를 오픈스택 외부에서 IP를 100개로 보느냐
Router IP 한 개로 보느냐 차이다.</p>
<ol class="arabic">
<li><p class="rubric" id="snat">SNAT 활성화</p>
<ol class="arabic">
<li><p class="rubric" id="id27">라우터 생성</p>
</li>
</ol>
</li>
</ol>
</li>
<li><div class="line-block">
<div class="line">아래와 같이 SNAT를 활성화 시킨 뒤 라우터를 생성 해준다.</div>
<div class="line">(고가용성 모드인 HA모드는 optional)</div>
</div>
</li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image23.png"><img alt="_images/image23.png" src="_images/image23.png" style="width: 4.76432in; height: 3.56482in;" /></a>
</div></blockquote>
<section id="private-snat-enabled">
<h3>Private 네트워크 생성 - SNAT Enabled<a class="headerlink" href="#private-snat-enabled" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Tenant 네트워크를 생성한다. 다른 Tenant에서도 사용할 네트워크라면
공유를 켜준다.</p></li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image24.png"><img alt="텍스트이(가) 표시된 사진 자동 생성된 설명" src="_images/image24.png" style="width: 4.79155in; height: 3.67401in;" /></a>
</div></blockquote>
<ol class="arabic">
<li><p class="rubric" id="id28">SNAT 비활성화</p>
<ol class="arabic">
<li><p class="rubric" id="id29">라우터 생성</p>
</li>
</ol>
</li>
</ol>
<ul>
<li><div class="line-block">
<div class="line">아래와 같이 SNAT를 비활성화 시킨 뒤 라우터를 생성해준다.</div>
<div class="line">(고가용성 모드인 HA모드는 optional)</div>
</div>
</li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image25.png"><img alt="텍스트이(가) 표시된 사진 자동 생성된 설명" src="_images/image25.png" style="width: 4.80765in; height: 3.61745in;" /></a>
</div></blockquote>
<ul class="simple">
<li><p>네트워크의 서브넷을 생성해준다. SNAT를 사용하므로 서브넷 클래스는
필요한만큼 편하게 A클래스든 C클래스든 만든다.</p></li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image26.png"><img alt="텍스트이(가) 표시된 사진 자동 생성된 설명" src="_images/image26.png" style="width: 4.82929in; height: 3.4524in;" /></a>
</div></blockquote>
</section>
<section id="private-snat-disabled">
<h3>Private 네트워크 생성 - SNAT Disabled<a class="headerlink" href="#private-snat-disabled" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Tenant 네트워크를 생성한다. 다른 Tenant에서도 사용할 네트워크라면
공유를 켜준다.</p></li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image24.png"><img alt="텍스트이(가) 표시된 사진 자동 생성된 설명" src="_images/image24.png" style="width: 4.79155in; height: 3.67401in;" /></a>
</div></blockquote>
<ul class="simple">
<li><p>네트워크 서브넷을 생성한다. SNAT를 사용하지 않으므로 실제 네트워크
환경에 맞도록 서브넷을 구성한다.</p></li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image27.png"><img alt="텍스트이(가) 표시된 사진 자동 생성된 설명" src="_images/image27.png" style="width: 4.77175in; height: 3.38573in;" /></a>
</div></blockquote>
</section>
<section id="l3-snat-disabled">
<h3>L3 라우팅 - SNAT Disabled<a class="headerlink" href="#l3-snat-disabled" title="Permalink to this headline">#</a></h3>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image28.png"><img alt="_images/image28.png" src="_images/image28.png" style="width: 2.44211in; height: 1.78769in;" /></a>
</div></blockquote>
<ul class="simple">
<li><p>위와 같이 Public 대역의 router 포트가 구성되고 하단 네트워크 포트가
다른 서브넷으로 잡힐 경우 상단에서의 ARP가 Router에서 포함된 서브넷이
아니기 때문에 ARP가 넘어오지 않으며 하단의 서브넷에서 올라오는
ARP들도 넘어가지 않게 된다.</p></li>
<li><p>따라서 Router 에서는 밑에서 위로 올라오는 ARP를 상단 게이트웨이로
넘겨주고, 상단의 10.104.105.0/24 서브넷에 대한 ARP를 밑으로 내려줄 수
있는 설정을 추가해준다.</p></li>
<li><p>상단 스위치</p></li>
</ul>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p># DELL 스위치 기준</p>
<p>ip route 10.104.105.0/24 10.104.102.10</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<ul class="simple">
<li><p>Router &gt; 정적경로</p></li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image29.png"><img alt="텍스트이(가) 표시된 사진 자동 생성된 설명" src="_images/image29.png" style="width: 6.19183in; height: 2.04698in;" /></a>
</div></blockquote>
<ul class="simple">
<li><p>(네트워크노드) Proxy ARP</p></li>
</ul>
<blockquote>
<div><p>아래의 스크립트는 ip netns 로 검색되는 qrouter 에 대하여 모든 포트에
대해 proxy_arp 를 0에서 1로 바꿔준다.</p>
</div></blockquote>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>#!/bin/bash</p>
<p>router_list=(<cite>ip netns | grep qrouter | awk ‘{print $1}’</cite>)</p>
<p>for router in ${router_list[&#64;]}</p>
<p>do</p>
<p>router_int=$(ip netns exec ${router} ls /sys/class/net/ | grep ^q)</p>
<p>for interface in ${router_int[&#64;]}</p>
<p>do</p>
<p>ip netns exec $router bash -c “echo 1 &gt;
/proc/sys/net/ipv4/conf/${interface}/proxy_arp”</p>
<p>done</p>
<p>done</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
</section>
<section id="compute-flavor">
<h1><strong>Compute Flavor 구성</strong><a class="headerlink" href="#compute-flavor" title="Permalink to this headline">#</a></h1>
<ul class="simple">
<li><p>관리 &gt; Compute &gt; Flavor 메뉴에서 사용할 Flavor 를 생성한다.</p></li>
<li><p>vCPU : 인스턴스에 제공할 가상화 코어 개수</p></li>
<li><p>RAM : 인스턴스에 제공할 메모리 량</p></li>
<li><p>Root 디스크 : 컴퓨트노드 안에 생성하여 사용할 디스크로 네트워크 기반
스토리지(ceph)을 사용하므로 0 으로 설정한다.</p></li>
<li><p>Ephermeral Disk : 인스턴스에서 사용하는 임시디스크로 사용하지 않는다.</p></li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image30.png"><img alt="_images/image30.png" src="_images/image30.png" style="width: 5.36214in; height: 5.68542in;" /></a>
</div></blockquote>
</section>
<section id="glance-image">
<h1><strong>Glance Image 업로드</strong><a class="headerlink" href="#glance-image" title="Permalink to this headline">#</a></h1>
<ul class="simple">
<li><p>Openstack 에서 사용할 인스턴스에 대한 초기이미지를 올린다.</p></li>
<li><p>기본적으로 qcow2 포멧으로 생성된 이미지를 사용한다. (확장자: .img
.qcow2)</p></li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image31.png"><img alt="_images/image31.png" src="_images/image31.png" style="width: 5.90796in; height: 4.72987in;" /></a>
</div></blockquote>
<ul class="simple">
<li><p><strong>(중요) 아래의 부팅부분 메타데이터를 포함하는 윈도우 이미지의 경우
메타데이터를 추가해주지 않으면 부팅되지 않는다.
(부팅부분 필수)
hw_disk_bus : scsi
hw_scsi_model : virtio-scsi
(성능부분 필수)
hw_cpu_sockets : 2
os_type : windows</strong></p></li>
</ul>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image32.png"><img alt="_images/image32.png" src="_images/image32.png" style="width: 5.00785in; height: 5.34519in;" /></a>
</div></blockquote>
</section>
<section id="id30">
<h1><strong>(Multi-Node) 호스트집합</strong><a class="headerlink" href="#id30" title="Permalink to this headline">#</a></h1>
<ul>
<li><div class="line-block">
<div class="line">관리 &gt; Compute &gt; 호스트집합 메뉴에서 Compute 노드들을 그룹핑해서
가용성 존을 나누는 것이 가능하다.</div>
<div class="line"><a class="reference internal" href="_images/image33.png"><img alt="텍스트이(가) 표시된 사진 자동 생성된 설명" src="_images/image33.png" style="width: 5.40099in; height: 3.63197in;" /></a></div>
</div>
</li>
</ul>
</section>
<section id="id31">
<h1><strong>3.6 인스턴스 생성</strong><a class="headerlink" href="#id31" title="Permalink to this headline">#</a></h1>
<blockquote>
<div><ul class="simple">
<li><p>프로젝트 &gt; Compute &gt; 인스턴스 메뉴로 이동하여 “인스턴스 시작”</p></li>
</ul>
<p>버튼으로 인스턴스를 생성한다.</p>
<a class="reference internal image-reference" href="_images/image34.png"><img alt="_images/image34.png" src="_images/image34.png" style="width: 6.34402in; height: 1.46265in;" /></a>
</div></blockquote>
<ol class="arabic" start="4">
<li><p class="rubric" id="vd-i"><strong>VD-i</strong></p>
<ol class="arabic">
<li><p class="rubric" id="id32"><strong>VD-i 인프라 구성도</strong></p>
</li>
</ol>
</li>
</ol>
<a class="reference internal image-reference" href="_images/image35.png"><img alt="_images/image35.png" src="_images/image35.png" style="width: 7.19167in; height: 1.95in;" /></a>
</section>
<section id="id33">
<h1><strong>VD-i 데이터 흐름도</strong><a class="headerlink" href="#id33" title="Permalink to this headline">#</a></h1>
<blockquote>
<div><a class="reference internal image-reference" href="_images/image36.png"><img alt="_images/image36.png" src="_images/image36.png" style="width: 4.08958in; height: 5.07708in;" /></a>
</div></blockquote>
<ol class="arabic" start="3">
<li><p class="rubric" id="id34"><strong>사전 작업</strong></p>
</li>
<li><p class="rubric" id="id35"><strong>VD-i 인프라 구축</strong></p>
<ol class="arabic">
<li><p class="rubric" id="id36"><strong>VD-i 브로커</strong></p>
<ol class="arabic">
<li><p class="rubric" id="id37">운영체재</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<ul>
<li><p><strong>20.04로 했어야했다………………</strong></p></li>
<li><p>OS : Ubuntu 18.04.5 LTS</p></li>
<li><p>Kernel : 4.15.0-176-generic</p>
<ol class="arabic">
<li><p class="rubric" id="id38">필수 패키지 설치</p>
</li>
</ol>
</li>
<li><p>apt install -y nginx haproxy</p>
<ol class="arabic">
<li><p class="rubric" id="debian">Debian 패키지로 설치하기</p>
</li>
</ol>
</li>
<li><div class="line-block">
<div class="line">nginx / mbroker / vsmgmt 를 몽땅 설치하는 Debian 패키지를 만들었다</div>
<div class="line">debian -i vdi-broker-1.0.1-0.deb</div>
</div>
<ol class="arabic">
<li><p class="rubric" id="nginx">Nginx 설정</p>
</li>
</ol>
</li>
<li><p>3.2. VD-i 데이터 흐름도에 따라 Nginx upstream을 구성한다.</p>
<ol class="arabic">
<li><p class="rubric" id="config">Config 파일</p>
</li>
</ol>
</li>
</ul>
<p><strong># /etc/hosts</strong></p>
<p><strong># /etc/nginx</strong></p>
<ul class="simple">
<li><p><strong>nginx.conf</strong></p></li>
</ul>
<p><strong># /etc/nginx/conf.d</strong></p>
<ul class="simple">
<li><p><strong>00-external-upstreams.conf</strong></p></li>
<li><p><strong>02-web-servers.conf</strong></p></li>
</ul>
<p><strong># /etc/nginx/modules-enabled</strong></p>
<ul class="simple">
<li><p><strong>01-stream-js.conf</strong></p></li>
<li><p><strong>02-stream-servers.conf</strong></p></li>
</ul>
<blockquote>
<div><p><strong># /etc/nginx/nginx.conf</strong></p>
</div></blockquote>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>user nginx;</p>
<p>worker_processes auto;</p>
<p>error_log /var/log/nginx/error.log error;</p>
<p>#error_log off;</p>
<p>pid /var/run/nginx.pid;</p>
<p>include /etc/nginx/modules-enabled/<a href="#id39"><span class="problematic" id="id40">*</span></a>.conf;</p>
<p>events {</p>
<p>worker_connections 1024;</p>
<p>}</p>
<p>http {</p>
<p>client_max_body_size 1000m;</p>
<p>include /etc/nginx/mime.types;</p>
<p>default_type application/octet-stream;</p>
<p>log_format main ‘$remote_addr - $remote_user [$time_local] “$request”
‘</p>
<p>‘$status $body_bytes_sent “$http_referer” ‘</p>
<p>‘”$http_user_agent” “$http_x_forwarded_for”’;</p>
<p>#access_log /var/log/nginx/access.log main;</p>
<p>access_log off;</p>
<p>sendfile on;</p>
<p>#tcp_nopush on;</p>
<p>keepalive_timeout 65;</p>
<p>add_header Strict-Transport-Security “max-age=63072000” always;</p>
<p>#gzip on;</p>
<p>include /etc/nginx/conf.d/<a href="#id41"><span class="problematic" id="id42">*</span></a>.conf;</p>
<p>server_tokens off;</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<div><p><strong>#/etc/nginx/conf.d/00-external-upstreams.conf</strong></p>
</div></blockquote>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>upstream prometheus-openstack {</p>
<p>server controller:3001;</p>
<p>}</p>
<p>upstream prometheus-vd {</p>
<p>server prom-vd:3001;</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<div><p><strong>#/etc/nginx/conf.d/02-web-servers.conf</strong></p>
</div></blockquote>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>#upstream ntlm_backend {</p>
<p># server 127.0.0.1:8000;</p>
<p># ntlm;</p>
<p>#}</p>
<p>upstream ap_backend {</p>
<p>server 127.0.0.1:8000;</p>
<p>}</p>
<p>server {</p>
<p>listen 127.0.0.1:7080 proxy_protocol;</p>
<p>location / {</p>
<p>proxy_pass <a class="reference external" href="http://127.0.0.1:9080">http://127.0.0.1:9080</a>;</p>
<p>proxy_set_header x-forwarded-for $proxy_protocol_addr;</p>
<p>}</p>
<p>}</p>
<p>server {</p>
<p>listen 127.0.0.1:9080 proxy_protocol;</p>
<p>server_name _;</p>
<p>proxy_headers_hash_max_size 2048;</p>
<p>proxy_headers_hash_bucket_size 128;</p>
<p>location /static {</p>
<p>proxy_pass <a class="reference external" href="http://ap_backend/api">http://ap_backend/api</a>;</p>
<p>}</p>
<p># location /portal/api/auth/ntlm {</p>
<p># proxy_pass <a class="reference external" href="http://ntlm_backend">http://ntlm_backend</a>;</p>
<p># proxy_set_header X-Forwarded-For $proxy_protocol_addr;</p>
<p># proxy_buffering off;</p>
<p># proxy_http_version 1.1;</p>
<p># proxy_set_header Connection “”;</p>
<p># }</p>
<p>location ~ ^/$ {</p>
<p>return 301 <a class="reference external" href="https://svdi.somansa.com/portal">https://svdi.somansa.com/portal</a>;</p>
<p>}</p>
<p>location / {</p>
<p>proxy_pass <a class="reference external" href="http://ap_backend">http://ap_backend</a>;</p>
<p>proxy_set_header X-Forwarded-For $proxy_protocol_addr;</p>
<p>limit_except GET POST PUT PATCH {</p>
<p>deny all;</p>
<p>}</p>
<p>}</p>
<p>location /prom-cloud {</p>
<p>proxy_pass <a class="reference external" href="http://prometheus-openstack">http://prometheus-openstack</a>;</p>
<p>proxy_redirect off;</p>
<p>}</p>
<p>location /prom-vd {</p>
<p>proxy_pass <a class="reference external" href="http://prometheus-vd">http://prometheus-vd</a>;</p>
<p>proxy_redirect off;</p>
<p>}</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<div><p><strong>#/etc/nginx/modules-enabled/01-stream-js.conf</strong></p>
</div></blockquote>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>load_module modules/ngx_stream_js_module.so;</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<div><p><strong>#/etc/nginx/modules-enabled/02-stream-servers.conf</strong></p>
</div></blockquote>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>stream {</p>
<p>js_import “/somansa/mbroker/share/nginx-examples/mbrk.js”;</p>
<p>js_set $upstream mbrk.upstream_type;</p>
<p>js_set $proxy_on mbrk.proxy_protocol_required;</p>
<p># mbroker backend</p>
<p>upstream mbrkback</p>
<p>{</p>
<p># use ip and port for mbroker service</p>
<p>server 127.0.0.1:7789;</p>
<p>}</p>
<p># webserver backend</p>
<p>upstream httpback</p>
<p>{</p>
<p># use local nginx for serving http</p>
<p>server 127.0.0.1:9080;</p>
<p>}</p>
<p>upstream tlsback</p>
<p>{</p>
<p># use local nginx for serving https</p>
<p>server 127.0.0.1:7443;</p>
<p>}</p>
<p>upstream proxyback</p>
<p>{</p>
<p># use local nginx for serving http/https proxy</p>
<p>server 127.0.0.1:7080;</p>
<p>}</p>
<p># default AUTO frontend</p>
<p>server {</p>
<p>listen 80;</p>
<p>listen 443;</p>
<p># detect mbrk before nginx core</p>
<p>js_preread mbrk.detect_mbrk;</p>
<p>proxy_connect_timeout 1s;</p>
<p>proxy_pass $upstream;</p>
<p>proxy_protocol on;</p>
<p>}</p>
<p># proxyfied AUTO frontend</p>
<p>server {</p>
<p>listen 90 proxy_protocol;</p>
<p>set_real_ip_from 0.0.0.0/0;</p>
<p># detect mbrk before nginx core</p>
<p>js_preread mbrk.detect_mbrk;</p>
<p>proxy_connect_timeout 1s;</p>
<p>proxy_pass $upstream;</p>
<p>proxy_protocol on;</p>
<p>}</p>
<p># TLS/SSL frontend</p>
<p>server {</p>
<p>listen 127.0.0.1:7443 ssl proxy_protocol;</p>
<p>set_real_ip_from 0.0.0.0/0;</p>
<p>ssl_certificate /etc/nginx/ssl/ssl.pem;</p>
<p>ssl_certificate_key /etc/nginx/ssl/ssl.key;</p>
<p>ssl_protocols TLSv1.2 TLSv1.3;</p>
<p>ssl_ciphers
ECDHE-ECDSA-AES128-
GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:
ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-C
HACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;</p>
<p>#add_header Strict-Transport-Security “max-age=63072000” always;</p>
<p>js_preread mbrk.detect_mbrk;</p>
<p>proxy_connect_timeout 1s;</p>
<p>proxy_pass $upstream;</p>
<p>proxy_protocol on;</p>
<p>}</p>
<p># MBRK frontend</p>
<p>server {</p>
<p>listen 127.0.0.1:7789 proxy_protocol;</p>
<p>proxy_connect_timeout 5s;</p>
<p>proxy_pass 127.0.0.1:9789;</p>
<p>}</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
<section id="haproxy">
<h2>HAProxy 설정<a class="headerlink" href="#haproxy" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Galera Cluster의 WSREP Deadlock 을 회피하기 위해 하나의 DB로만
억세스하기 위해 사용</p></li>
</ul>
<blockquote>
<div><p># /etc/haproxy/haproxy.cfg</p>
</div></blockquote>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>global</p>
<p>log 127.0.0.1 local2</p>
<p>maxconn 1024</p>
<p>user root</p>
<p>group root</p>
<p>daemon</p>
<p>stats socket /var/run/haproxy.sock mode 600 level admin</p>
<p>defaults</p>
<p>log global</p>
<p>mode tcp</p>
<p>option dontlognull</p>
<p>option tcp-smart-accept</p>
<p>option tcp-smart-connect</p>
<p>option redispatch</p>
<p>retries 3</p>
<p>timeout connect 10s</p>
<p>timeout client 480m</p>
<p>timeout server 480m</p>
<p>frontend mysql_cluster_frontend</p>
<p>bind *:3306</p>
<p>mode tcp</p>
<p>option tcplog</p>
<p>default_backend galera_cluster_backend</p>
<p>backend galera_cluster_backend</p>
<p>mode tcp</p>
<p>option tcpka</p>
<p>balance leastconn</p>
<p>server VD-i_MariaDB-1 10.104.72.7:3306 check weight 1</p>
<p>server VD-i_MariaDB-2 10.104.72.8:3306 check backup</p>
<p>server VD-i_MariaDB-3 10.104.72.9:3306 check backup</p>
<p>listen stats</p>
<p>bind *:9000</p>
<p>mode http</p>
<p>log global</p>
<p>stats enable</p>
<p>stats refresh 5s</p>
<p>stats uri /stats</p>
<p>stats realm HAProxy\ Statistics</p>
<p>stats auth admin:myPassword!</p>
<p>stats admin if TRUE</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="mbroker">
<h2>Mbroker 설치<a class="headerlink" href="#mbroker" title="Permalink to this headline">#</a></h2>
<blockquote>
<div><p># /somansa/mbroker/share/nginx-examples/mbrk.js</p>
</div></blockquote>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>var is_mbrk = 0;</p>
<p>var is_tls = 0;</p>
<p>var is_proxy = 0;</p>
<p>function detect_mbrk(s) {</p>
<p>s.on(‘upload’, function (data, flags) {</p>
<p>if(data.startsWith(‘MBRK’) == true)</p>
<p>{</p>
<p>is_mbrk = 1;</p>
<p>}</p>
<p>if(data.startsWith(’\x05\x01’) == true)</p>
<p>{</p>
<p>is_mbrk = 1;</p>
<p>}</p>
<p>if(data.startsWith(’\x05\x02’) == true)</p>
<p>{</p>
<p>is_mbrk = 1;</p>
<p>}</p>
<p>if(data.startsWith(’\x16\x03’) == true)</p>
<p>{</p>
<p>is_tls = 1;</p>
<p>}</p>
<p>if(data.startsWith(‘GET http’) == true)</p>
<p>{</p>
<p>is_proxy = 1;</p>
<p>}</p>
<p>if(data.startsWith(‘POST http’) == true)</p>
<p>{</p>
<p>is_proxy = 1;</p>
<p>}</p>
<p>if(data.startsWith(‘CONNECT ‘) == true)</p>
<p>{</p>
<p>is_proxy = 1;</p>
<p>}</p>
<p>if (data.length || flags.last)</p>
<p>{</p>
<p>s.done();</p>
<p>}</p>
<p>});</p>
<p>}</p>
<p>function upstream_type(s) {</p>
<p>if(is_mbrk == 1)</p>
<p>{</p>
<p>return “mbrkback”;</p>
<p>}</p>
<p>if(is_tls == true)</p>
<p>{</p>
<p>return “tlsback”;</p>
<p>}</p>
<p>if(is_proxy == true)</p>
<p>{</p>
<p>return “proxyback”;</p>
<p>}</p>
<p>return “httpback”;</p>
<p>}</p>
<p>export default {detect_mbrk, upstream_type}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="vsmgmt">
<h2>VSMGMT 설치<a class="headerlink" href="#vsmgmt" title="Permalink to this headline">#</a></h2>
<ol class="arabic">
<li><p class="rubric" id="vd-i-mariadb"><strong>VD-i MariaDB</strong></p>
<ol class="arabic">
<li><p class="rubric" id="id43">운영체재</p>
</li>
</ol>
</li>
<li><p class="rubric" id="vd-i-vsmetric">VD-i VSMetric</p>
</li>
</ol>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, joseph paik
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/scripts/furo.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>